<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellina Cloud | ë¼ë²¨ ë° ì¬ê³  ì‹œìŠ¤í…œ</title>
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@400;500;700;900&family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #cbd5e1; 
            margin: 0; padding: 0; color: #1e293b;
            overflow-x: hidden; 
        }
        
        /* í™”ë©´ ë¯¸ë¦¬ë³´ê¸°ìš© A4 ì»¨í…Œì´ë„ˆ (í™”ë©´ì—ì„œë§Œ ìƒí•˜ì¢Œìš° 5mm ìœ ì§€) */
        .a4-paper-container {
            background: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            box-sizing: border-box;
            position: relative;
            width: 297mm;
            min-height: 210mm;
            padding: 5mm; 
            transition: all 0.2s ease;
            transform-origin: top center;
        }

        /* ğŸš¨ ì¸ì‡„ ì„¤ì •: ë¸Œë¼ìš°ì € ê°•ì œ ì„¤ì • ì™„ë²½ ë¬´ë ¥í™” ë° ì—¬ë°± 0 ì²˜ë¦¬ ğŸš¨ */
        @media print {
            @page { 
                size: A4 landscape; 
                margin: 0 !important; /* ë¸Œë¼ìš°ì € ì—¬ë°± ê°•ì œ 0 */
            }
            .no-print { display: none !important; }
            
            /* Tailwindì˜ í™”ë©´ ë ˆì´ì•„ì›ƒ ì†ì„±ì„ ì¸ì‡„ ì‹œ ì™„ì „íˆ ì†Œê±° (ì²« í˜ì´ì§€ ì—¬ë°± ë° 1í˜ì´ì§€ ì˜ë¦¼ í•´ê²°ì˜ í•µì‹¬) */
            html, body, #root, .print-wrapper, main { 
                background: white !important; 
                display: block !important; 
                position: static !important;
                height: auto !important; 
                min-height: 0 !important;
                max-height: none !important;
                width: 100% !important;
                overflow: visible !important; 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            
            header { display: none !important; } 

            .print-pages-wrapper {
                display: block !important;
                gap: 0 !important; 
                margin: 0 !important;
                padding: 0 !important;
            }

            .a4-paper-container { 
                box-shadow: none !important; 
                border: none !important; 
                width: 297mm !important; /* A4 ê°€ë¡œí­ ê°•ì œ */
                height: 210mm !important; /* A4 ì„¸ë¡œí­ ê°•ì œí•˜ì—¬ ë¸Œë¼ìš°ì € ì˜¤ì°¨ ë°©ì§€ */
                min-height: 210mm !important;
                max-height: 210mm !important;
                margin: 0 !important; 
                padding: 0 !important; /* ì‚¬ìš©ì ìš”ì²­ëŒ€ë¡œ ì—¬ë°± ì™„ë²½ ì œê±° */
                display: flex !important;
                position: relative !important;
                overflow: hidden !important; /* ì •í•´ì§„ A4 ê·œê²©ì„ ë„˜ëŠ” ë¯¸ì„¸í•œ ì˜¤ì°¨ ì ˆì‚­ */
                page-break-after: always !important; 
                break-after: page !important;
            }
            
            .a4-paper-container:last-child {
                page-break-after: auto !important;
                break-after: auto !important;
            }
            
            /* ë°•ìŠ¤ ê¹¨ì§ 2ì¤‘ ë°©ì§€ */
            .group\/box {
                page-break-inside: avoid !important;
                break-inside: avoid-page !important;
                width: 100% !important;
            }
            
            table { page-break-inside: auto !important; width: 100% !important; }
            tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        .tab-button {
            padding: 12px 20px; font-weight: 800; font-size: 13px;
            transition: all 0.3s; border-radius: 10px 10px 0 0;
            position: relative; bottom: -1px; display: flex; align-items: center; gap: 6px;
        }
        .tab-inactive { background: #0f172a; color: #64748b; }
        .tab-active { background: #ffffff; color: #4f46e5; border: 1px solid #e2e8f0; border-bottom: 2px solid white; }

        .cell-textarea {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            overflow: hidden;
            line-height: 1.4;
            padding: 8px 12px;
            display: block;
            white-space: pre-wrap;
            word-break: break-all;
            text-align: left; 
            vertical-align: middle;
        }

        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.98); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        td.v-middle { vertical-align: middle !important; }

        .color-dot-sm {
            width: 22px; height: 22px;
            border-radius: 4px; cursor: pointer;
            border: 1px solid rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        .color-dot-sm:hover { transform: scale(1.15); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // ğŸš¨ íšŒìƒ‰/í°ìƒ‰ì„ ì œê±°í•œ ì„ ëª…í•˜ê³  ë‹¤ì±„ë¡œìš´ ê³ ëŒ€ë¹„ 30ìƒ‰ íŒ”ë ˆíŠ¸ ğŸš¨
        const PRESET_COLORS = [
            "#ef4444", "#3b82f6", "#22c55e", "#f97316", "#8b5cf6", 
            "#06b6d4", "#ec4899", "#eab308", "#6366f1", "#14b8a6",
            "#f43f5e", "#84cc16", "#a855f7", "#0ea5e9", "#10b981",
            "#f59e0b", "#d946ef", "#0284c7", "#b91c1c", "#15803d",
            "#c2410c", "#4338ca", "#be185d", "#ca8a04", "#0f766e",
            "#4d7c0f", "#1d4ed8", "#047857", "#b45309", "#000000" 
        ];

        const ICON_PATHS = {
            'cloud': <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.1-3.9-4.4C17.6 6.5 14.1 4 10 4 6.4 4 3.4 6.3 2.2 9.5 0.9 10.4 0 11.9 0 13.5 0 16.5 2.5 19 5.5 19h12z"/>,
            'search': <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            'printer': <><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>,
            'plus': <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            'trash': <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>,
            'x': <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            'save': <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
            'refresh': <><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
            'settings': <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
            'palette': <><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></>,
            'folder-plus': <><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></>
        };

        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE_S_2HKvPX6R3lRLZ_z6bI-RLxgX3E4D3oZziAEBHRcqRUWGXakX2NeMcRgl4VZbk/exec";
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1bC9nm1nAUjHV1L3-B5o8wUO1VpvjFXElN4CPquxZBgU/edit?usp=sharing";

        const INITIAL_DATA = {
            sample: { 
                title: "ìƒ˜í”Œ ëª©ë¡", printCols: 2, orientation: "landscape", fontSize: 13, titleFontSize: 16, fontFamily: "'Noto Sans KR', sans-serif",
                items: [{ id: Date.now(), cat: "ê¸°ë³¸ë¶„ë¥˜", name: "ìƒ˜í”Œ ì œí’ˆëª…", origin: "êµ­ì‚°", vendor: "ê¸°ë³¸ ê³µê¸‰ì²˜", checked: false }], 
                themes: { "ê¸°ë³¸ë¶„ë¥˜": "#3b82f6" }, order: ["ê¸°ë³¸ë¶„ë¥˜"]
            },
            carton: { 
                title: "ì¹´í†¤ë°•ìŠ¤", printCols: 2, orientation: "landscape", fontSize: 13, titleFontSize: 16, fontFamily: "'Noto Sans KR', sans-serif",
                items: [{ id: Date.now()+1, cat: "ìƒì‚°ë¼ë²¨", name: "ë°•ìŠ¤ ì œí’ˆëª…", origin: "", vendor: "2026.12.31", checked: false }], 
                themes: { "ìƒì‚°ë¼ë²¨": "#ef4444" }, order: ["ìƒì‚°ë¼ë²¨"]
            }
        };

        const EditableTitle = ({ initialValue, onSave, className = "", style = {} }) => {
            const [val, setVal] = useState(initialValue);
            const [isEditing, setIsEditing] = useState(false);
            useEffect(() => { setVal(initialValue); }, [initialValue]);
            const handleBlur = () => { 
                setIsEditing(false);
                if (val !== initialValue && val.trim()) onSave(val); 
                else setVal(initialValue);
            };
            return (
                <div className={`relative flex items-center group/edit ${className}`}>
                    <input 
                        value={val} onChange={e => setVal(e.target.value)}
                        onFocus={() => setIsEditing(true)} onBlur={handleBlur}
                        onKeyDown={e => e.key === 'Enter' && e.target.blur()}
                        style={style}
                        className={`outline-none bg-transparent transition-all rounded px-3 w-full font-black text-left ${isEditing ? 'bg-white/20 ring-1 ring-white/50' : 'cursor-text hover:bg-white/10'}`} 
                    />
                </div>
            );
        };

        const Icon = ({ name, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {ICON_PATHS[name] || <circle cx="12" cy="12" r="10" />}
            </svg>
        );

        const ComplexColorPicker = ({ label, colorKey, currentColor, onColorSelect }) => (
            <div className="space-y-3 p-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
                <div className="flex justify-between items-center mb-1">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{label}</label>
                    <div className="relative group">
                        <input type="color" value={currentColor} onChange={e => onColorSelect(colorKey, e.target.value)} className="w-6 h-6 p-0 border-0 cursor-pointer bg-transparent opacity-0 absolute inset-0 z-10" />
                        <div className="w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center bg-slate-50 group-hover:bg-white transition-all shadow-sm"><Icon name="palette" size={12} className="text-indigo-500" /></div>
                    </div>
                </div>
                <div className="grid grid-cols-6 gap-1.5">
                    {PRESET_COLORS.map(c => (
                        <div key={c} className={`color-dot-sm ${currentColor.toUpperCase() === c.toUpperCase() ? 'ring-2 ring-indigo-500 ring-offset-2' : ''}`} style={{ backgroundColor: c }} onClick={() => onColorSelect(colorKey, c)} />
                    ))}
                </div>
            </div>
        );

        const App = () => {
            const [tabData, setTabData] = useState(() => {
                const saved = localStorage.getItem('cellina_inventory_final_v61');
                return saved ? JSON.parse(saved) : INITIAL_DATA;
            });
            const [scriptUrl, setScriptUrl] = useState(() => localStorage.getItem('cellina_script_url') || DEFAULT_SCRIPT_URL);
            const [sheetUrl, setSheetUrl] = useState(() => localStorage.getItem('cellina_sheet_url') || DEFAULT_SHEET_URL);

            const [activeTab, setActiveTab] = useState("sample");
            const [searchTerm, setSearchTerm] = useState("");
            const [labelModal, setLabelModal] = useState(null);
            const [isConfigOpen, setIsConfigOpen] = useState(false);
            const [isFetching, setIsFetching] = useState(false);

            const tabNameMapping = { 'sample': 'ìƒ˜í”Œëª©ë¡', 'carton': 'ì¹´í†¤ë°•ìŠ¤' };

            useEffect(() => {
                localStorage.setItem('cellina_inventory_final_v61', JSON.stringify(tabData));
                localStorage.setItem('cellina_script_url', scriptUrl.trim());
                localStorage.setItem('cellina_sheet_url', sheetUrl.trim());
            }, [tabData, scriptUrl, sheetUrl]);

            const current = tabData[activeTab];

            const filteredItems = useMemo(() => {
                const term = searchTerm.toLowerCase();
                if (!term) return current.items;
                return current.items.filter(item => 
                    item.name.toLowerCase().includes(term) || 
                    item.cat.toLowerCase().includes(term) ||
                    item.vendor.toLowerCase().includes(term)
                );
            }, [current.items, searchTerm]);

            const updateCurrentData = (updates) => {
                setTabData(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], ...updates } }));
            };

            const editItem = (id, f, v) => {
                updateCurrentData({ items: current.items.map(i => i.id === id ? { ...i, [f]: v } : i) });
            };

            const renameCategory = (oldName, newName) => {
                if (!newName || oldName === newName) return;
                const nextItems = current.items.map(i => i.cat === oldName ? { ...i, cat: newName } : i);
                const nextOrder = current.order.map(c => c === oldName ? newName : c);
                const nextThemes = { ...current.themes };
                if (nextThemes[oldName]) {
                    nextThemes[newName] = nextThemes[oldName];
                    delete nextThemes[oldName];
                }
                updateCurrentData({ items: nextItems, order: nextOrder, themes: nextThemes });
            };

            const addNewCategory = () => {
                const newCatName = prompt("ìƒˆë¡œìš´ ë¶„ë¥˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
                if (!newCatName || current.order.includes(newCatName)) return;
                const nextOrder = [newCatName, ...current.order];
                const nextThemes = { ...current.themes };
                nextThemes[newCatName] = PRESET_COLORS[nextOrder.length % PRESET_COLORS.length];
                const newItem = { id: Date.now(), cat: newCatName, name: "", origin: "", vendor: "", checked: false };
                updateCurrentData({ items: [newItem, ...current.items], order: nextOrder, themes: nextThemes });
            };

            const fetchDataFromSheet = async () => {
                const cScript = scriptUrl.trim();
                const cSheet = sheetUrl.trim();
                if (!cScript || !cSheet) { alert("í™˜ê²½ì„¤ì •ì—ì„œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                setIsFetching(true);
                try {
                    const sTab = tabNameMapping[activeTab];
                    const fetchUrl = `${cScript}?action=read&tab=${encodeURIComponent(sTab)}&sheetUrl=${encodeURIComponent(cSheet)}&t=${Date.now()}`;
                    const res = await fetch(fetchUrl);
                    const text = await res.text();
                    if (text.trim().startsWith("<!DOCTYPE")) throw new Error("ê¶Œí•œ ì˜¤ë¥˜: ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì‹œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ 'ëª¨ë“  ì‚¬ìš©ì'ë¡œ ì„¤ì •í•˜ì„¸ìš”.");
                    const data = JSON.parse(text);
                    if (data && Array.isArray(data)) {
                        const dataRows = data.slice(1);
                        const validRows = dataRows.filter(row => row[0] || row[1]);
                        const newItems = validRows.map((row, idx) => ({
                            id: Date.now() + idx, cat: row[0] ? String(row[0]).trim() : "ê¸°ë³¸",
                            name: row[1] ? String(row[1]).trim() : "", origin: row[2] ? String(row[2]).trim() : "",
                            vendor: row[3] ? String(row[3]).trim() : "", checked: false
                        }));
                        const uniqueCats = [...new Set(newItems.map(i => i.cat))];
                        const newThemes = { ...current.themes };
                        uniqueCats.forEach((c, i) => { if(!newThemes[c]) newThemes[c] = PRESET_COLORS[i % PRESET_COLORS.length]; });
                        updateCurrentData({ items: newItems, order: uniqueCats, themes: newThemes });
                        alert(`âœ… [${sTab}] ë™ê¸°í™” ì™„ë£Œ!`);
                    }
                } catch (err) { alert("âš ï¸ ì—°ë™ ì‹¤íŒ¨: " + err.message); }
                setIsFetching(false);
            };

            const pushToGoogleSheet = async () => {
                const cScript = scriptUrl.trim();
                const cSheet = sheetUrl.trim();
                if (!cScript || !cSheet) { alert("í™˜ê²½ì„¤ì •ì—ì„œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                try {
                    const pushData = current.items.map(item => [item.cat, item.name, item.origin || "", item.vendor || ""]);
                    pushData.unshift(["ë¶„ë¥˜", "ì œí’ˆëª…", "ì›ì‚°ì§€", "ê³µê¸‰ì²˜"]);
                    const sTab = tabNameMapping[activeTab];
                    const payload = { tab: sTab, sheetUrl: cSheet, data: pushData };
                    await fetch(cScript, { method: "POST", body: JSON.stringify(payload) });
                    alert(`âœ… [${sTab}] ì €ì¥ ì™„ë£Œ!`);
                } catch (err) { alert("âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + err.message); }
            };

            const openLabelMaker = (item) => {
                const isSingle = item.cat === 'ë°•ìŠ¤ë¼ë²¨';
                const footerTextVal = activeTab === 'carton' ? item.vendor : `${item.origin} / ${item.vendor}`;
                const config = item.labelSettings || {
                    mainText: item.name, footerText: isSingle ? "" : footerTextVal,
                    bgTop: "#EF4444", bgBottom: "#FFFFFF", colorTop: "#FFFFFF", colorBottom: "#000000",
                    fontFamily: "'Noto Sans KR', sans-serif", mainSize: 140, footerSize: 90, isSingleZone: isSingle
                };
                setLabelModal({ ...config, itemId: item.id });
            };

            const saveLabelSettings = () => {
                updateCurrentData({ items: current.items.map(i => i.id === labelModal.itemId ? { ...i, name: labelModal.mainText, labelSettings: { ...labelModal } } : i) });
                alert("ë¼ë²¨ ì„¤ì •ì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            // ğŸš¨ í˜ì‹ ì  ìŠ¤ë§ˆíŠ¸ í˜ì´ì§• ì‹œìŠ¤í…œ (í”½ì…€ ë‹¨ìœ„ ì •ë°€ ê³„ì‚°) ğŸš¨
            const pages = useMemo(() => {
                if (labelModal) return [];

                // A4 ê°€ë¡œ(Landscape) ê¸°ì¤€ ê°€ìš© ë†’ì´ ì„¤ì • (í”½ì…€ ë‹¨ìœ„). 
                // ì¢…ì´ ë†’ì´(793px)ì—ì„œ ì•ˆì „ ì—¬ë°±ì„ ëº€ ì‹¤ì œ ë°•ìŠ¤ê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê³µê°„
                const MAX_COL_HEIGHT = current.orientation === 'landscape' ? 760 : 1100;
                
                // ì œëª©ê³¼ í…Œì´ë¸” í—¤ë”ê°€ ì°¨ì§€í•˜ëŠ” ê¸°ë³¸ ë†’ì´
                const headerHeight = current.titleFontSize + 45; 
                
                let chunks = [];
                
                // 1ë‹¨ê³„: ê° ì•„ì´í…œì˜ ì‹¤ì œ ì°¨ì§€ ë†’ì´(px)ë¥¼ ê³„ì‚°í•˜ì—¬ ë°•ìŠ¤ ìª¼ê°œê¸°
                current.order.forEach(cat => {
                    const catItems = filteredItems.filter(i => i.cat === cat);
                    
                    if (!searchTerm && catItems.length === 0) {
                        chunks.push({ id: `${cat}-empty`, title: cat, originalCat: cat, items: [], theme: current.themes[cat], height: headerHeight + 50 });
                    } else if (catItems.length > 0) {
                        let currentChunk = [];
                        let currentHeight = headerHeight;
                        let chunkIndex = 1;

                        // í•œ ì¤„ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê¸€ì ìˆ˜ (í°íŠ¸ í¬ê¸°ì— ë°˜ë¹„ë¡€)
                        const nameLimit = Math.max(10, Math.floor(230 / current.fontSize));
                        const originLimit = Math.max(4, Math.floor(80 / current.fontSize));
                        const vendorLimit = Math.max(5, Math.floor(110 / current.fontSize));

                        const getEstimatedLines = (str, limit) => {
                            if (!str) return 1;
                            return str.split('\n').reduce((acc, line) => acc + Math.max(1, Math.ceil(line.length / limit)), 0);
                        };

                        catItems.forEach((item) => {
                            const nameLines = getEstimatedLines(item.name, nameLimit);
                            const originLines = getEstimatedLines(item.origin, originLimit);
                            const vendorLines = getEstimatedLines(item.vendor, vendorLimit);
                            const maxLines = Math.max(nameLines, originLines, vendorLines);

                            // íŒ¨ë”©(16px) + ì¤„ë†’ì´(ê¸€ìí¬ê¸°*1.4) + í…Œë‘ë¦¬(1px)
                            const rowHeight = 16 + (maxLines * current.fontSize * 1.4) + 1;

                            // ë°•ìŠ¤ ë†’ì´ê°€ A4 ê°€ìš© ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ë©´ ê°•ì œ ë¶„í• 
                            if (currentHeight + rowHeight > MAX_COL_HEIGHT && currentChunk.length > 0) {
                                chunks.push({
                                    id: `${cat}-${chunkIndex}`,
                                    title: cat, // ğŸ‘ˆ '(ê³„ì†)' ë¬¸êµ¬ ì‚­ì œ. ì™„ë²½íˆ ë™ì¼í•œ ì´ë¦„ ì‚¬ìš©.
                                    originalCat: cat,
                                    items: currentChunk,
                                    theme: current.themes[cat],
                                    height: currentHeight
                                });
                                currentChunk = [item];
                                currentHeight = headerHeight + rowHeight;
                                chunkIndex++;
                            } else {
                                currentChunk.push(item);
                                currentHeight += rowHeight;
                            }
                        });

                        if (currentChunk.length > 0) {
                            chunks.push({
                                id: `${cat}-${chunkIndex}`,
                                title: cat, 
                                originalCat: cat,
                                items: currentChunk,
                                theme: current.themes[cat],
                                height: currentHeight
                            });
                        }
                    }
                });

                // 2ë‹¨ê³„: ìª¼ê°œì§„ ë°•ìŠ¤ë“¤ì„ ë¬¼ë¦¬ì ì¸ 'A4 í˜ì´ì§€' ë‹¨ìœ„ë¡œ ë¶„ë°° (2ë‹¨ êµ¬ì„±)
                let newPages = [];
                let currentPage = { cols: Array.from({length: current.printCols}, () => []), colHeights: Array(current.printCols).fill(0) };
                const BOX_GAP = 20; // ë°•ìŠ¤ ê°„ê²© (px)
                
                chunks.forEach(chunk => {
                    let placed = false;
                    for (let c = 0; c < current.printCols; c++) {
                        const addedHeight = chunk.height + (currentPage.cols[c].length > 0 ? BOX_GAP : 0);
                        if (currentPage.colHeights[c] + addedHeight <= MAX_COL_HEIGHT) {
                            currentPage.cols[c].push(chunk);
                            currentPage.colHeights[c] += addedHeight;
                            placed = true;
                            break;
                        }
                    }

                    // í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  ë‹¨ì´ ê°€ë“ ì°¼ìœ¼ë©´ ë‹¤ìŒ í˜ì´ì§€(ìƒˆ A4 ìš©ì§€)ë¡œ ìƒì„±
                    if (!placed) {
                        newPages.push(currentPage);
                        currentPage = { cols: Array.from({length: current.printCols}, () => []), colHeights: Array(current.printCols).fill(0) };
                        currentPage.cols[0].push(chunk);
                        currentPage.colHeights[0] = chunk.height;
                    }
                });
                
                if (currentPage.cols.some(col => col.length > 0)) {
                    newPages.push(currentPage);
                }

                return newPages.length > 0 ? newPages : [{cols: Array.from({length: current.printCols}, () => [])}];
            }, [current.items, current.fontSize, current.titleFontSize, current.orientation, current.printCols, current.order, current.themes, filteredItems, searchTerm, labelModal]);

            // ê³µí†µ ë°•ìŠ¤ ë Œë”ë§
            const renderBox = (block) => (
                <div key={block.id} className="group/box border-2 border-slate-900 bg-white break-inside-avoid rounded-lg overflow-hidden shadow-sm h-fit">
                    <div style={{ backgroundColor: block.theme }} className="flex justify-between items-center p-2 text-white print:hidden border-b-2 border-slate-900">
                        <EditableTitle initialValue={block.title} onSave={(v) => renameCategory(block.originalCat, v)} style={{ fontSize: `${current.titleFontSize}px` }} className="flex-1" />
                        <div className="flex gap-1 no-print items-center text-white pr-2">
                            <button onClick={() => updateCurrentData({ items: [{ id: Date.now(), cat: block.originalCat, name: "", origin: "", vendor: "", checked: false }, ...current.items] })} className="bg-white/20 p-1.5 rounded hover:bg-white/40"><Icon name="plus" size={14}/></button>
                            <div className="relative group">
                                <input type="color" value={block.theme} onChange={e => setTabData(prev => ({...prev, [activeTab]: {...prev[activeTab], themes: {...prev[activeTab].themes, [block.originalCat]: e.target.value}}}))} className="w-6 h-6 p-0 bg-transparent border-0 cursor-pointer absolute inset-0 opacity-0 z-10" />
                                <div className="w-6 h-6 rounded border border-white/30 flex items-center justify-center bg-white/10 group-hover:bg-white/20 transition-colors"><Icon name="palette" size={12} className="text-white" /></div>
                            </div>
                            <button onClick={() => confirm(`'${block.title}' ë¶„ë¥˜ë¥¼ ì‚­ì œí• ê¹Œìš”?`) && updateCurrentData({ items: current.items.filter(i => i.cat !== block.originalCat), order: current.order.filter(c => c !== block.originalCat) })} className="bg-white/20 p-1.5 rounded hover:bg-red-500/40"><Icon name="trash" size={14}/></button>
                        </div>
                    </div>
                    <div style={{ backgroundColor: block.theme, fontSize: `${current.titleFontSize}px`, textAlign: 'left', padding: '10px 15px' }} className="hidden print:block text-white font-black border-b-2 border-slate-900">{block.title}</div>
                    
                    <table className="w-full border-collapse" style={{ fontSize: `${current.fontSize}px` }}>
                        <thead className="bg-slate-50 border-b-2 border-slate-900 font-bold text-left">
                            <tr>
                                <th className="w-10 border-r border-slate-900 py-2 text-center">V</th>
                                <th className="px-4 border-r border-slate-900">ì œí’ˆëª…</th>
                                {activeTab !== 'carton' && <th className="w-24 px-4 border-r border-slate-900">ì›ì‚°ì§€</th>}
                                <th className="w-32 px-4">{activeTab === 'carton' ? 'ì†Œë¹„ê¸°í•œ' : 'ê³µê¸‰ì²˜'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {block.items.length === 0 ? (
                                <tr><td colSpan="4" className="py-6 text-center text-slate-300 italic">ë‚´ìš© ì—†ìŒ</td></tr>
                            ) : (
                                block.items.map(item => (
                                    <tr key={item.id} className="border-b border-slate-200 group/row hover:bg-slate-50 transition-colors">
                                        <td className="border-r border-slate-200 v-middle text-center">
                                            <input type="checkbox" checked={item.checked} onChange={() => editItem(item.id, 'checked', !item.checked)} className="mx-auto block" style={{width:'15px', height:'15px'}} />
                                        </td>
                                        <td className="border-r border-slate-200 v-middle text-left">
                                            <div className="flex items-center justify-between">
                                                <textarea value={item.name} onChange={e => editItem(item.id, 'name', e.target.value)} className="cell-textarea font-black text-slate-800" rows={item.name.split('\n').length || 1} />
                                                <div className="flex gap-1 no-print opacity-0 group-hover/row:opacity-100 transition-opacity p-1 shrink-0">
                                                    {activeTab === 'carton' && <button onClick={() => openLabelMaker(item)} className="text-indigo-500 hover:scale-110"><Icon name="printer" size={14}/></button>}
                                                    <button onClick={() => updateCurrentData({ items: current.items.filter(i => i.id !== item.id) })} className="text-red-400 hover:scale-110"><Icon name="trash" size={14}/></button>
                                                </div>
                                            </div>
                                        </td>
                                        {activeTab !== 'carton' && (
                                            <td className="border-r border-slate-200 v-middle text-left">
                                                <textarea value={item.origin} onChange={e => editItem(item.id, 'origin', e.target.value)} className="cell-textarea font-medium" rows={item.origin.split('\n').length || 1} />
                                            </td>
                                        )}
                                        <td className="v-middle text-left">
                                            <textarea value={item.vendor} onChange={e => editItem(item.id, 'vendor', e.target.value)} className="cell-textarea text-slate-500 font-medium" rows={item.vendor.split('\n').length || 1} />
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            );

            return (
                <div className="h-screen flex flex-col overflow-hidden print-wrapper">
                    <header className="no-print bg-slate-900 text-white z-50 shrink-0 border-b border-slate-700">
                        <div className="max-w-[1600px] mx-auto p-3 flex justify-between items-center gap-4">
                            <div className="flex items-center gap-2">
                                <Icon name="cloud" className="text-indigo-400" />
                                <h1 className="text-md font-black tracking-tighter uppercase italic">Cellina Cloud</h1>
                            </div>

                            {!labelModal && (
                                <div className="flex-1 max-w-md relative group">
                                    <Icon name="search" size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input type="text" placeholder="í†µí•© ê²€ìƒ‰..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full bg-slate-800 border-none rounded-xl pl-9 pr-10 py-2 text-xs outline-none focus:ring-2 ring-indigo-500 focus:bg-slate-950 transition-all" />
                                </div>
                            )}

                            <div className="flex items-center gap-2">
                                {!labelModal ? (
                                    <div className="flex bg-slate-800 rounded-lg p-1 gap-3 items-center px-4 border border-slate-700">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[9px] font-bold text-slate-500">TIT</span>
                                            <input type="range" min="10" max="35" value={current.titleFontSize} onChange={e => updateCurrentData({ titleFontSize: parseInt(e.target.value) })} className="w-16 h-1 accent-indigo-500" />
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[9px] font-bold text-slate-500">TXT</span>
                                            <input type="range" min="8" max="25" value={current.fontSize} onChange={e => updateCurrentData({ fontSize: parseInt(e.target.value) })} className="w-16 h-1 accent-emerald-500" />
                                        </div>
                                    </div>
                                ) : null}

                                {!labelModal && <button onClick={addNewCategory} className="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-lg font-bold text-[11px] flex items-center gap-2 transition-all shadow-lg shadow-indigo-500/20"><Icon name="folder-plus" size={12} /> ë¶„ë¥˜ ì¶”ê°€</button>}
                                
                                <button onClick={fetchDataFromSheet} className="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg font-bold text-[11px] flex items-center gap-2 transition-all"><Icon name="refresh" size={12} className={isFetching ? "animate-spin" : ""} /> {labelModal ? "ì‹œíŠ¸ ê°±ì‹ " : "ê°±ì‹ "}</button>
                                <button onClick={pushToGoogleSheet} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold text-[11px] flex items-center gap-2 shadow-lg shadow-blue-500/20"><Icon name="save" size={12} /> {labelModal ? "ì‹œíŠ¸ ì €ì¥" : "ì €ì¥"}</button>

                                {!labelModal ? (
                                    <>
                                        <button onClick={() => window.print()} className="bg-white text-slate-900 px-4 py-2 rounded-lg font-black text-[11px] flex items-center gap-2 hover:bg-slate-100 transition-colors"><Icon name="printer" size={12} /> ì¸ì‡„</button>
                                        <button onClick={() => setIsConfigOpen(!isConfigOpen)} className="p-2 text-slate-400 hover:text-white transition-colors"><Icon name="settings" /></button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => window.print()} className="bg-white text-slate-900 px-4 py-2 rounded-lg font-black text-[11px] flex items-center gap-2 hover:bg-slate-100 transition-colors"><Icon name="printer" size={12} /> ë¼ë²¨ ì¸ì‡„</button>
                                        <button onClick={() => setLabelModal(null)} className="bg-red-500 hover:bg-red-400 px-4 py-2 rounded-lg font-bold text-[11px] text-white flex items-center gap-2 transition-colors"><Icon name="x" size={12} /> ì—ë””í„° ë‹«ê¸°</button>
                                    </>
                                )}
                            </div>
                        </div>

                        {isConfigOpen && (
                            <div className="absolute top-16 right-6 bg-slate-800 border border-slate-700 p-5 rounded-2xl w-[400px] shadow-2xl animate-pop no-print z-50">
                                <label className="text-[10px] font-bold text-slate-500 block mb-1">API URL</label>
                                <input value={scriptUrl} onChange={e=>setScriptUrl(e.target.value)} className="w-full bg-slate-900 rounded p-2 text-[10px] text-indigo-300 font-mono mb-4 outline-none border border-white/5" />
                                <label className="text-[10px] font-bold text-slate-500 block mb-1">êµ¬ê¸€ ì‹œíŠ¸ URL</label>
                                <input value={sheetUrl} onChange={e=>setSheetUrl(e.target.value)} className="w-full bg-slate-900 rounded p-2 text-[10px] text-slate-400 font-mono mb-6 outline-none" />
                                <button onClick={()=>setIsConfigOpen(false)} className="w-full bg-indigo-600 py-3 rounded-xl font-bold text-xs text-white">ì„¤ì • ì €ì¥ ë° ë‹«ê¸°</button>
                            </div>
                        )}

                        {!labelModal && (
                            <div className="px-6 flex gap-1 border-t border-slate-800 overflow-x-auto no-scrollbar">
                                {Object.keys(tabData).map(key => (
                                    <button key={key} onClick={() => setActiveTab(key)} className={`tab-button min-w-[100px] ${activeTab === key ? 'tab-active' : 'tab-inactive'}`}>
                                        <span className="uppercase font-black">{tabData[key].title}</span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    <main className="flex-1 overflow-auto bg-slate-300 p-8 flex flex-col items-center">
                        {!labelModal ? (
                            <div className="print-pages-wrapper w-full flex flex-col items-center gap-10">
                                {/* ğŸš¨ ê³„ì‚°ëœ 'í˜ì´ì§€' ë‹¨ìœ„ë¡œ A4 ì»¨í…Œì´ë„ˆë¥¼ ì™„ë²½í•˜ê²Œ ë¶„í•  ë Œë”ë§ ğŸš¨ */}
                                {pages.map((page, pageIdx) => (
                                    <div key={pageIdx} className={`a4-paper-container flex gap-5 ${activeTab === 'carton' ? 'carton-view-mode' : ''}`}>
                                        {page.cols.map((colBlocks, colIdx) => (
                                            <div key={colIdx} className="flex flex-col gap-5 flex-1 w-full h-fit">
                                                {colBlocks.map(block => renderBox(block))}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="flex flex-col lg:flex-row gap-8 max-w-[1400px] w-full items-start animate-pop">
                                <div className="flex-1 bg-white p-12 rounded-3xl shadow-2xl border border-slate-200 flex justify-center sticky top-0">
                                    <div className="bg-white shadow-xl overflow-hidden flex flex-col border border-black/10" style={{ width: '280mm', height: '190mm', fontFamily: labelModal.fontFamily, zoom: '0.45' }}>
                                        <div style={{ backgroundColor: labelModal.bgTop, color: labelModal.colorTop, height: labelModal.isSingleZone ? '100%' : '72%' }} className="flex flex-col justify-center items-center p-12 text-center transition-all">
                                            <div style={{ fontSize: `${labelModal.mainSize}px`, fontWeight: '900', lineHeight: '1.1', whiteSpace: 'pre-wrap' }}>{labelModal.mainText}</div>
                                        </div>
                                        {!labelModal.isSingleZone && (
                                            <div style={{ backgroundColor: labelModal.bgBottom, color: labelModal.colorBottom, height: '28%' }} className="flex justify-center items-center border-t-4 border-black/10">
                                                <div style={{ fontSize: `${labelModal.footerSize}px`, fontWeight: '900' }}>{labelModal.footerText}</div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="w-[420px] space-y-4 no-print editor-sidebar p-2">
                                    <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-200">
                                        <div className="flex justify-between items-center mb-6 text-slate-400">
                                            <h3 className="font-black text-xs uppercase tracking-tighter">ë¼ë²¨ ìŠ¤íƒ€ì¼ ì—ë””í„°</h3>
                                        </div>
                                        <div className="flex bg-slate-100 p-1 rounded-2xl mb-6">
                                            <button onClick={() => setLabelModal({...labelModal, isSingleZone: false})} className={`flex-1 py-3 text-[10px] font-black rounded-xl transition-all ${!labelModal.isSingleZone ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}>í‘œì¤€ (2ë‹¨)</button>
                                            <button onClick={() => setLabelModal({...labelModal, isSingleZone: true})} className={`flex-1 py-3 text-[10px] font-black rounded-xl transition-all ${labelModal.isSingleZone ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`}>ë‹¨ì¼ (1ë‹¨)</button>
                                        </div>
                                        <div className="space-y-6">
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">ë©”ì¸ ì œí’ˆëª…</label><textarea value={labelModal.mainText} onChange={e => setLabelModal({...labelModal, mainText: e.target.value})} className="w-full border-2 border-slate-100 p-4 rounded-2xl h-32 font-bold text-sm bg-slate-50 focus:border-indigo-500 outline-none transition-all" /></div>
                                            {!labelModal.isSingleZone && (<div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">í•˜ë‹¨ ì¶”ê°€ ì •ë³´</label><input value={labelModal.footerText} onChange={e => setLabelModal({...labelModal, footerText: e.target.value})} className="w-full border-2 border-slate-100 p-4 rounded-2xl font-bold text-sm bg-slate-50 focus:border-indigo-500 outline-none transition-all" /></div>)}
                                            <ComplexColorPicker label="ë°°ê²½ ìƒ‰ìƒ" colorKey="bgTop" currentColor={labelModal.bgTop} onColorSelect={(k,v) => setLabelModal({...labelModal, [k]:v})} />
                                            <ComplexColorPicker label="ê¸€ì ìƒ‰ìƒ" colorKey="colorTop" currentColor={labelModal.colorTop} onColorSelect={(k,v) => setLabelModal({...labelModal, [k]:v})} />
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase flex justify-between tracking-widest">ê¸€ì í¬ê¸° <span className="text-indigo-600 font-mono">{labelModal.mainSize}px</span></label><input type="range" min="40" max="600" value={labelModal.mainSize} onChange={e => setLabelModal({...labelModal, mainSize: parseInt(e.target.value)})} className="w-full h-2 accent-indigo-600 bg-slate-100 rounded-lg appearance-none cursor-pointer" /></div>
                                            <button onClick={saveLabelSettings} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all transform active:scale-95">ì—ë””í„° ë¡œì»¬ ì €ì¥</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
