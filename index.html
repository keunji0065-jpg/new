<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (ì˜¤ë¥˜ìˆ˜ì •ì™„ë£Œ)</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .processed-chat { text-decoration: line-through; background-color: #f1f5f9 !important; color: #94a3b8 !important; opacity: 0.6; }
        .selected-chat-active { border-left: 3px solid #3b82f6; background-color: #eff6ff; }
        .badge-pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .keyword-detected { border: 2px solid #60a5fa; background-color: #eff6ff; }
        .keyword-badge { background-color: #3b82f6; color: white; padding: 1px 5px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; }
        .copy-anim { animation: copySuccess 0.3s ease-in-out; }
        .animate-pop { animation: pop 0.2s ease-out; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-scale-up { animation: scaleUp 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes copySuccess { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyIJYsEH9MNxwtbnkF31dKEjYb996KoFQja5UYVAV5ObEyuGUAMTxWdH3ql9nLM-gW8A/exec";
        const FIXED_BANK_ACCOUNT = "ì¹´ì¹´ì˜¤ë±…í¬ ê¹€ì„ ì •\n7942 18 01611";
        const DEFAULT_CUSTOMER_SHEET_ID = "1zlL6R8iCy-6ZRMqj6dbefhkwSyRzHibDYBNJLmE35bM";
        
        const Icon = ({ name, className="", weight="regular", size }) => <i className={`ph ph-${name} ${className}`} data-phosphor-icon-weight={weight} style={{fontSize: size}}></i>;

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const Modal = ({ isOpen, type, message, onConfirm, onCancel, initialValue }) => {
            const [inputValue, setInputValue] = useState(initialValue || '');
            const inputRef = useRef(null);
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (!isOpen) return;
                    if (type !== 'prompt') {
                        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); onConfirm(); }
                    } else { if (e.key === 'Enter') onConfirm(inputValue); }
                    if (e.key === 'Escape' && type !== 'alert') onCancel();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isOpen, type, inputValue, onConfirm, onCancel]);

            useEffect(() => { if (isOpen && type === 'prompt' && inputRef.current) { setInputValue(initialValue || ''); setTimeout(() => inputRef.current.focus(), 100); } }, [isOpen, type, initialValue]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] animate-fade-in" onClick={type === 'alert' ? () => onConfirm() : undefined}>
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-80 max-w-sm animate-scale-up" onClick={e => e.stopPropagation()}>
                        <div className="mb-4">
                            {type === 'confirm' && <div className="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 mb-3 mx-auto"><Icon name="question" size={24} weight="bold"/></div>}
                            {type === 'alert' && <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mb-3 mx-auto"><Icon name="info" size={24} weight="bold"/></div>}
                            {type === 'prompt' && <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mb-3 mx-auto"><Icon name="pencil" size={24} weight="bold"/></div>}
                            <h3 className="text-lg font-bold text-center text-gray-800 mb-2">{type === 'confirm' ? 'í™•ì¸' : type === 'prompt' ? 'ì…ë ¥' : 'ì•Œë¦¼'}</h3>
                            <p className="text-sm text-gray-600 text-center whitespace-pre-wrap leading-relaxed">{message}</p>
                        </div>
                        {type === 'prompt' && (<input ref={inputRef} type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full border rounded-lg px-3 py-2 mb-5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50"/>)}
                        <div className="flex gap-2">
                            {type !== 'alert' && (<button onClick={onCancel} className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">ì·¨ì†Œ</button>)}
                            <button onClick={() => type === 'prompt' ? onConfirm(inputValue) : onConfirm()} className="flex-1 py-2.5 rounded-lg text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-sm">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LiveTab = ({ orders, setOrders, productHistory, setProductHistory, quickShipping, setQuickShipping, shippingOverrides, setShippingOverrides, bankAccount, googleScriptUrl, addresses, cardPayments, setCardPayments, resetAllStatus, matchedDeposits, setMatchedDeposits, depositorNames, setDepositorNames, clickedChats, setClickedChats, openModal, keywords, setKeywords, sentAddressRequests, setSentAddressRequests, deletedDepositIds, setDeletedDepositIds }) => {
            const [chats, setChats] = useState([]);
            const [serverDeposits, setServerDeposits] = useState([]); 
            const [manualDeposits, setManualDeposits] = useState([]); 
            const [selectedNick, setSelectedNick] = useState(null); 
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            const [newDepositName, setNewDepositName] = useState('');
            const [newDepositAmount, setNewDepositAmount] = useState('');
            const [chatSearch, setChatSearch] = useState('');
            const [depositSearch, setDepositSearch] = useState('');
            const [orderSearch, setOrderSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all'); 
            const [keywordInput, setKeywordInput] = useState('');
            const [showKeywordOnly, setShowKeywordOnly] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: 'ì—°ê²° ì¤‘...' }); 
            const [copyStatus, setCopyStatus] = useState({});
            const [isSaving, setIsSaving] = useState(false);
            const [editingShippingNick, setEditingShippingNick] = useState(null);
            const [editingQuantityId, setEditingQuantityId] = useState(null);
            const [currentSearchTerm, setCurrentSearchTerm] = useState('');

            const fetchData = async () => {
                if (!googleScriptUrl) { setConnectionStatus({ code: 'error_config', msg: 'ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }); return; }
                try {
                    const fetchUrl = `${googleScriptUrl}?t=${Date.now()}`;
                    const res = await fetch(fetchUrl); 
                    if (!res.ok) throw new Error(`HTTP ì˜¤ë¥˜ ${res.status}`);
                    const text = await res.text();
                    if (text.trim().startsWith("<!DOCTYPE html") || text.includes("Google Accounts")) { setConnectionStatus({ code: 'error_auth', msg: 'âš ï¸ êµ¬ê¸€ ë°°í¬ ê¶Œí•œ í™•ì¸ í•„ìš”' }); return; }
                    const data = JSON.parse(text);
                    if (data.chats) {
                        const cleanChats = data.chats.map(chat => ({ ...chat, nickname: chat.nickname.replace(/@/g, '').trim() }));
                        setChats(cleanChats); 
                        if (cleanChats.length === 0 && data.deposits.length === 0) setConnectionStatus({ code: 'warning_empty', msg: 'ë°ì´í„° 0ê±´ (ì—°ê²°ë¨)' });
                        else setConnectionStatus({ code: 'success', msg: 'ğŸŸ¢ ì—°ê²° ì„±ê³µ' });
                    }
                    if (data.deposits) {
                        const stableDeposits = data.deposits.map((d, i) => ({ ...d, id: d.uid || `dep_${d.name}_${d.amount}_${i}`, source: 'server' }));
                        setServerDeposits(stableDeposits);
                    }
                } catch (e) { console.warn("í†µì‹  ì‹¤íŒ¨:", e); setConnectionStatus({ code: 'error_fetch', msg: 'ì—°ê²° ì¬ì‹œë„ ì¤‘...' }); }
            };
            useEffect(() => { fetchData(); const interval = setInterval(fetchData, 5000); return () => clearInterval(interval); }, [googleScriptUrl]);

            const allDeposits = useMemo(() => [...manualDeposits, ...serverDeposits], [manualDeposits, serverDeposits]);
            const findAddress = (nick) => addresses.find(a => a.nickname.trim() === nick.trim());
            const handleAddKeyword = (e) => { e.preventDefault(); if(!keywordInput.trim()) return; setKeywords(prev => new Set(prev).add(keywordInput.trim())); setKeywordInput(''); };
            const handleRemoveKeyword = (keyword) => { setKeywords(prev => { const next = new Set(prev); next.delete(keyword); return next; }); };
            const toggleCardPayment = (nick) => { setCardPayments(prev => ({ ...prev, [nick]: !prev[nick] })); };
            const handleAddManualDeposit = (e) => { e.preventDefault(); if (!newDepositName.trim() || !newDepositAmount) return openModal("ì…ê¸ˆìëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert'); const newDep = { id: `manual_${Date.now()}`, name: newDepositName, amount: newDepositAmount, source: 'manual' }; setManualDeposits(prev => [newDep, ...prev]); setNewDepositName(''); setNewDepositAmount(''); };
            const handleDeleteManualDeposit = (id) => { openModal("ì´ ìˆ˜ë™ ì…ê¸ˆ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setManualDeposits(prev => prev.filter(d => d.id !== id)); setMatchedDeposits(prev => { const next = new Set(prev); next.delete(id); return next; }); }); };
            const handleDeleteDepositItem = (id) => { openModal("ì´ ì…ê¸ˆ ë‚´ì—­ì„ ëª©ë¡ì—ì„œ ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™˜ë¶ˆ ë“±ìœ¼ë¡œ ì¸í•´ ì‚­ì œ í•„ìš”ì‹œ)", 'confirm', () => { setManualDeposits(prev => prev.filter(d => d.id !== id)); setDeletedDepositIds(prev => new Set(prev).add(id)); setMatchedDeposits(prev => { const next = new Set(prev); next.delete(id); return next; }); }); };

            const autoSaveToGoogleSheet = async () => {
                if (!googleScriptUrl || Object.keys(orders).length === 0) return; 
                setIsSaving(true);
                const saveList = orders.filter(o=>!o.isCancelled).map(o => {
                    const addr = findAddress(o.customer) || {};
                    const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping);
                    return { nickname: o.customer, product: o.product, qty: o.quantity, price: o.price, deposit: o.deposit, shipping: currentShipping, grandTotal: 0, address: addr.address || '', zipcode: addr.zipcode || '', phone: addr.phone || '', realname: addr.realname || '', memo: addr.memo || '' };
                });
                try { await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify(saveList), mode: 'no-cors' }); } catch(e) { console.error("ì €ì¥ ì‹¤íŒ¨", e); } finally { setIsSaving(false); }
            };
            useEffect(() => { const saveInterval = setInterval(autoSaveToGoogleSheet, 60000); return () => clearInterval(saveInterval); }, [orders, shippingOverrides, quickShipping, googleScriptUrl]); 
            
            // âœ… handleLoadOrders í•¨ìˆ˜ ì¶”ê°€ (ëˆ„ë½ëœ ë¶€ë¶„)
            const handleLoadOrders = async () => {
                openModal("ì„œë²„ì— ì €ì¥ëœ ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤!)", 'confirm', async () => {
                    if (!googleScriptUrl) return openModal("ì„¤ì •ì—ì„œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert');
                    try {
                        const res = await fetch(`${googleScriptUrl}?action=get_orders&t=${Date.now()}`);
                        const data = await res.json();
                        if (data && data.orders && Array.isArray(data.orders)) {
                            const loadedOrders = data.orders.map((o, idx) => ({ 
                                id: Date.now() + idx, 
                                customer: o.nickname || o.customer, 
                                product: o.product, 
                                quantity: Number(o.qty || o.quantity), 
                                price: Number(o.price), 
                                deposit: Number(o.deposit), 
                                isCancelled: false 
                            }));
                            setOrders(loadedOrders);
                            openModal(`ì´ ${loadedOrders.length}ê±´ì˜ ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`, 'alert');
                        } else { 
                            openModal("ì €ì¥ëœ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.", 'alert'); 
                        }
                    } catch(e) { 
                        openModal("ë¡œë“œ ì‹¤íŒ¨: " + e.message, 'alert'); 
                    }
                });
            };

            const addOrderLogic = (nickname, content, qty = 1) => {
                const cleanNick = nickname.replace(/@/g, '').trim();
                const initialProduct = content || '';
                const initialPrice = productHistory[initialProduct] || 0;
                
                setSelectedNick(cleanNick); 
                setOrderSearch('');

                setOrders(prev => {
                    // 1. ìƒí’ˆëª… ìˆëŠ” ê²½ìš° ì¤‘ë³µ ì²´í¬
                    if (initialProduct !== '') {
                        const existIdx = prev.findIndex(o => o.customer === cleanNick && o.product === initialProduct && !o.isCancelled);
                        if (existIdx >= 0) { 
                            const next = [...prev]; 
                            next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + qty, price: (next[existIdx].quantity + qty) * initialPrice }; 
                            return next; 
                        }
                    }

                    const newOrder = { id: Date.now(), customer: cleanNick, product: initialProduct, quantity: qty, price: initialPrice, deposit: 0, originalText: content, isCancelled: false };
                    
                    // 2. í•´ë‹¹ ê³ ê°ì˜ ë§ˆì§€ë§‰ ì£¼ë¬¸ ì¸ë±ìŠ¤ ì°¾ê¸°
                    let lastIdx = -1;
                    for (let i = prev.length - 1; i >= 0; i--) {
                         if (prev[i].customer === cleanNick) {
                             lastIdx = i;
                             break;
                         }
                    }

                    if (lastIdx !== -1) {
                        const next = [...prev];
                        next.splice(lastIdx + 1, 0, newOrder);
                        return next;
                    } else {
                        // ì‹ ê·œ ê³ ê°ì´ë©´ ë§¨ ì•ì— ì¶”ê°€ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
                        return [newOrder, ...prev];
                    }
                });
            };
            
            const handleProductKeyDown = (e, nick, items, currentIndex) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    if (currentIndex < items.length - 1) {
                        const nextInputId = `prod-input-${items[currentIndex + 1].id}`;
                        const nextInput = document.getElementById(nextInputId);
                        if (nextInput) nextInput.focus();
                    } else {
                        addOrderLogic(nick, '', 1);
                        setTimeout(() => {
                            const userInputs = document.querySelectorAll(`input[data-customer="${nick}"]`);
                            if (userInputs.length > 0) {
                                userInputs[userInputs.length - 1].focus();
                            }
                        }, 50);
                    }
                }
            };
            
            const handleProductPaste = (e, nick, items, currentIndex) => {
                const pasteData = e.clipboardData.getData('text');
                if (!pasteData) return;

                const lines = pasteData.split(/\r\n|\r|\n/).filter(line => line.trim() !== '');
                
                if (lines.length > 1) {
                    e.preventDefault(); 
                    
                    const firstLine = lines[0].trim();
                    setOrders(prev => {
                        const newOrders = [...prev];
                        const targetIndex = newOrders.findIndex(o => o.id === items[currentIndex].id);
                        if (targetIndex === -1) return prev;

                        const currentOrder = newOrders[targetIndex];
                        const price1 = productHistory[firstLine] ? currentOrder.quantity * productHistory[firstLine] : currentOrder.price;
                        newOrders[targetIndex] = { ...currentOrder, product: firstLine, price: price1 };
                        
                        lines.slice(1).forEach((line, i) => {
                            const prodName = line.trim();
                            const unitPrice = productHistory[prodName] || 0;
                            const newOrder = {
                                id: Date.now() + i + 1,
                                customer: nick,
                                product: prodName,
                                quantity: 1,
                                price: unitPrice,
                                deposit: 0,
                                isCancelled: false
                            };
                            newOrders.splice(targetIndex + 1 + i, 0, newOrder);
                        });

                        return newOrders;
                    });
                }
            };

            const handleChatClick = (chat) => { setClickedChats(prev => new Set(prev).add(chat.id)); addOrderLogic(chat.nickname, chat.content, 1); };
            const handleManualSubmit = (e) => { e.preventDefault(); if (!manualNick.trim()) return openModal("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert'); addOrderLogic(manualNick, manualProduct, 1); setManualProduct(''); };
            const handleDepositClick = (deposit) => {
                const depositId = deposit.id;
                const currentMatched = matchedDeposits || new Set();
                if (currentMatched.has(depositId)) {
                    openModal("ì´ ì…ê¸ˆ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => {
                        if (selectedNick) {
                            const depositAmount = Number(deposit.amount);
                            setOrders(prev => {
                                const targetOrders = prev.filter(o => o.customer === selectedNick);
                                const otherOrders = prev.filter(o => o.customer !== selectedNick);
                                if (targetOrders.length === 0) return prev;
                                const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: Math.max(0, (o.deposit || 0) - depositAmount) }; return o; });
                                return [...updatedTargets, ...otherOrders];
                            });
                        }
                        setMatchedDeposits(prev => { const next = new Set(prev); next.delete(depositId); return next; });
                    });
                    return;
                }
                if (!selectedNick) return openModal("ì˜¤ë¥¸ìª½ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!", 'alert');
                const depositAmount = Number(deposit.amount);
                setOrders(prev => {
                    const targetOrders = prev.filter(o => o.customer === selectedNick);
                    const otherOrders = prev.filter(o => o.customer !== selectedNick);
                    if (targetOrders.length === 0) return prev;
                    const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                    return [...updatedTargets, ...otherOrders];
                });
                setMatchedDeposits(prev => new Set(prev).add(depositId));
            };

            const handleFullDepositToggle = (nick, grandTotal, currentDeposit) => {
                const isPaid = currentDeposit >= grandTotal;
                if (isPaid) { openModal(`'${nick}'ë‹˜ì˜ ì…ê¸ˆ ìƒíƒœë¥¼ 'ë¯¸ë‚©(0ì›)'ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'confirm', () => { setOrders(prev => prev.map(o => o.customer === nick ? { ...o, deposit: 0 } : o)); }); } 
                else { setOrders(prev => { let processed = false; return prev.map(o => { if (o.customer === nick) { if (!processed) { processed = true; return { ...o, deposit: grandTotal }; } else { return { ...o, deposit: 0 }; } } return o; }); }); }
            };

            const resetUserDeposit = (nick) => { openModal(`'${nick}'ë‹˜ì˜ ì…ê¸ˆì•¡ì„ 0ì›ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'confirm', () => { setOrders(prev => prev.map(o => o.customer === nick ? { ...o, deposit: 0 } : o)); }); };
            const handleProductChange = (id, field, value) => {
                if (field === 'product') setCurrentSearchTerm(value); 
                setOrders(prev => prev.map(o => {
                    if (o.id === id) {
                        const newOrder = { ...o, [field]: value };
                        if (field === 'product' && productHistory[value]) newOrder.price = newOrder.quantity * productHistory[value];
                        if (field === 'price' && o.product) { const unitPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: unitPrice })); }
                        return newOrder;
                    } return o;
                }));
            };
            const handleQuantityUpdate = (itemId, newQtyVal) => {
                const newQty = parseInt(newQtyVal, 10);
                if (isNaN(newQty) || newQty < 1) return setEditingQuantityId(null); 
                setOrders(prev => prev.map(o => { if (o.id === itemId) { let unitPrice = 0; if (o.quantity > 0 && o.price > 0) { unitPrice = o.price / o.quantity; } else if (productHistory[o.product]) { unitPrice = productHistory[o.product]; } return { ...o, quantity: newQty, price: unitPrice * newQty }; } return o; }));
                setEditingQuantityId(null);
            };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            const handleNicknameEdit = (oldNick) => { openModal(`'${oldNick}'ë‹˜ì˜ ë‹‰ë„¤ì„ì„ ë³€ê²½í•©ë‹ˆë‹¤.`, 'prompt', (newNickRaw) => { if (newNickRaw && newNickRaw !== oldNick) { const newNick = newNickRaw.replace(/@/g, '').trim(); setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o)); if (shippingOverrides[oldNick]) { const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] }; delete newOverrides[oldNick]; setShippingOverrides(newOverrides); } if (selectedNick === oldNick) setSelectedNick(newNick); } }, null, oldNick); };
            const handleOrderCancel = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o)); };
            const handleOrderDelete = (id) => { openModal("ì´ ì£¼ë¬¸ í•­ëª©ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setOrders(prev => prev.filter(o => o.id !== id)); }); };

            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance, isCard) => {
                const activeItems = items.filter(i => !i.isCancelled);
                const hasZeroPrice = activeItems.some(i => Number(i.price) === 0);
                const addr = findAddress(nick);

                const itemListText = activeItems.map(i => `${i.product}${i.quantity > 1 ? `(${i.quantity}ê°œ)` : ''} ${Number(i.price).toLocaleString()}ì›`).join('\n');
                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                
                let msg = `ğŸ’™ ${nick} ë‹˜ ğŸ’™\n\n\n${itemListText}\në°°ì†¡ë¹„ ${currentShipping.toLocaleString()}ì›\n\nì´ ì£¼ë¬¸ê¸ˆì•¡ ${grandTotal.toLocaleString()}ì›\n------------------\n`;
                if (isCard) { const cardBase = Math.abs(balance); if (depositTotal > 0) msg += `[ì…ê¸ˆí™•ì¸]\n${depositTotal.toLocaleString()}ì›\n\n`; msg += `[ì¹´ë“œê²°ì œ]\nê¸ˆì•¡ ${cardBase.toLocaleString()}ì›\n10% ${(cardBase * 0.1).toLocaleString()}ì›\nğŸ‘‰ì´ ${(cardBase * 1.1).toLocaleString()}ì› ì˜ˆì •\n\ní•¸ë“œí°ë²ˆí˜¸ ë‚¨ê²¨ì£¼ì„¸ìš”ğŸŒ¸\n------------------\n\n`; } 
                else { const isPaid = (balance <= 0) && (grandTotal > 0) && !hasZeroPrice; if (depositTotal > 0) msg += `[ì…ê¸ˆí™•ì¸]\n${depositTotal.toLocaleString()}ì›\n------------------\n\n`; if (isPaid) msg += `ì™„ë‚© í™•ì¸! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜\n------------------\n\n`; else msg += `[ë¯¸ì…ê¸ˆ]\nì´ ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡\nğŸ‘‰ ${(balance > 0 ? balance : 0).toLocaleString()}ì› \n\n${FIXED_BANK_ACCOUNT}\nì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n------------------\n\n`; }
                if (!addr) { if (!sentAddressRequests.has(nick)) { msg += `ë°©ì†¡ë§ˆë‹¤ 1íšŒ\ní•˜ë‹¨ì˜ ì£¼ë¬¸ì„œ(ë°°ì†¡ì§€ì…ë ¥) í•„ìˆ˜!!\n\nì´ë¯¸ ì°¸ì—¬í•œ ì„¤ë¬¸ ì¼ ê²½ìš°\nâ–« ë‹µë³€ ìˆ˜ì •í•˜ê¸° \nâ–« ë˜ëŠ” ì„¤ë¬¸ ì¶”ê°€ ì°¸ì—¬\n\në¯¸ì…ë ¥ì´ ë§ì•„ ê³„ì† ì•ˆë‚´í•©ë‹ˆë‹¤. \nì–‘í•´ë¶€íƒë“œë¦½ë‹ˆë‹¤.`; setSentAddressRequests(prev => new Set(prev).add(nick)); } }

                const textArea = document.createElement("textarea"); textArea.value = msg; document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); setCopyStatus(prev => ({ ...prev, [nick]: true })); setTimeout(() => { setCopyStatus(prev => ({ ...prev, [nick]: false })); }, 2000); } catch (err) { openModal('ë³µì‚¬ ì‹¤íŒ¨', 'alert'); }
                document.body.removeChild(textArea);
            };

            const filteredChats = useMemo(() => { let result = chats; const keywordsArray = Array.from(keywords || []); if (showKeywordOnly) result = result.filter(c => keywordsArray.some(k => c.content.includes(k))); if (chatSearch) result = result.filter(c => c.nickname.includes(chatSearch) || c.content.includes(chatSearch)); return result; }, [chats, chatSearch, showKeywordOnly, keywords]);
            
            const filteredDeposits = useMemo(() => { 
                let result = [...allDeposits]; 
                result = result.filter(d => !deletedDepositIds.has(d.id));

                if (depositSearch) {
                    result = result.filter(d => (d.name||'').includes(depositSearch) || String(d.amount).includes(depositSearch));
                }

                result.sort((a, b) => {
                    const aUsed = matchedDeposits?.has(a.id) || false;
                    const bUsed = matchedDeposits?.has(b.id) || false;
                    if (aUsed && !bUsed) return 1;
                    if (!aUsed && bUsed) return -1;

                    if (selectedNick) {
                        const targetNick = String(selectedNick).replace(/\s/g, '').toLowerCase(); 
                        const depositorName = depositorNames && depositorNames[selectedNick];
                        const targetReal = depositorName ? String(depositorName).replace(/\s/g, '').toLowerCase() : '';
                        
                        const nameA = a.name ? String(a.name).replace(/\s/g, '').toLowerCase() : '';
                        const nameB = b.name ? String(b.name).replace(/\s/g, '').toLowerCase() : '';
                        
                        const getScore = (val, target) => { 
                            if (!target || !val) return 10; 
                            if (val === target) return 0; 
                            if (val.startsWith(target) || target.startsWith(val)) return 1; 
                            if (val.includes(target) || target.includes(val)) return 2; 
                            for (let i = 0; i < target.length - 1; i++) {
                                if (val.includes(target.substring(i, i + 2))) return 3;
                            }
                            return 10; 
                        };
                        
                        const scoreA = Math.min(getScore(nameA, targetNick), getScore(nameA, targetReal));
                        const scoreB = Math.min(getScore(nameB, targetNick), getScore(nameB, targetReal));
                        
                        if (scoreA !== scoreB) return scoreA - scoreB;
                    }
                    return 0; 
                });
                return result; 
            }, [allDeposits, depositSearch, selectedNick, depositorNames, matchedDeposits, deletedDepositIds]);
            
            const filteredProductList = useMemo(() => {
                if (!currentSearchTerm) return Object.keys(productHistory);
                const terms = currentSearchTerm.toLowerCase().split(/\s+/).filter(t => t); 
                return Object.keys(productHistory).filter(name => {
                    const n = name.toLowerCase();
                    return terms.every(term => n.includes(term));
                });
            }, [productHistory, currentSearchTerm]);

            const totalDepositAmount = useMemo(() => filteredDeposits.reduce((sum, d) => sum + Number(d.amount), 0), [filteredDeposits]);
            
            const filteredGroupedOrders = useMemo(() => { 
                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                
                let groupedArray = Object.entries(groups);
                
                groupedArray.sort((a, b) => {
                    const maxTimeA = a[1].length > 0 ? Math.max(...a[1].map(item => item.id)) : 0;
                    const maxTimeB = b[1].length > 0 ? Math.max(...b[1].map(item => item.id)) : 0;
                    return maxTimeB - maxTimeA; 
                });

                return groupedArray.filter(([nick, items]) => { 
                    if (orderSearch) { const term = orderSearch.toLowerCase(); if (!nick.toLowerCase().includes(term) && !items.some(i => i.product && i.product.toLowerCase().includes(term))) return false; } 
                    const isCard = cardPayments[nick]; 
                    const activeItems = items.filter(i => !i.isCancelled); 
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); 
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping); 
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); 
                    const grandTotal = productTotal + (activeItems.length > 0 ? currentShipping : 0); 
                    const balance = grandTotal - depositTotal; 
                    
                    const isPaid = (balance <= 0) && (grandTotal >= 0) && (activeItems.length > 0);
                    
                    if (filterStatus === 'unpaid') { if (isCard || isPaid) return false; } 
                    if (filterStatus === 'paid') { if (!isPaid && !isCard) return false; } 
                    return true; 
                }); 
            }, [orders, orderSearch, filterStatus, shippingOverrides, quickShipping, cardPayments]);
            
            const totalItemsCount = useMemo(() => { let count = 0; filteredGroupedOrders.forEach(([_, items]) => { count += items.filter(i => !i.isCancelled).length; }); return count; }, [filteredGroupedOrders]);
            const dashboardStats = useMemo(() => { let totalSales = 0, totalDeposit = 0, totalUnpaid = 0, totalCardExpected = 0; const groups = {}; orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); }); Object.entries(groups).forEach(([nick, items]) => { const activeItems = items.filter(i => !i.isCancelled); if (activeItems.length === 0) return; const isCard = cardPayments[nick]; const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping); const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); const grandTotal = productTotal + currentShipping; const balance = grandTotal - depositTotal; totalSales += grandTotal; totalDeposit += depositTotal; if (balance > 0) { if (isCard) totalCardExpected += (balance * 1.1); else totalUnpaid += balance; } }); return { totalSales, totalDeposit, totalUnpaid, totalCardExpected }; }, [orders, shippingOverrides, quickShipping, cardPayments]);

            return (
                <div className="flex h-full gap-2 p-2 overflow-hidden bg-gray-50 text-slate-800">
                    <datalist id="product-list">
                        {filteredProductList.map(name => <option key={name} value={name} />)}
                    </datalist>
                    <div className="w-[30%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-indigo-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-indigo-700 flex items-center justify-between"><div className="flex items-center gap-2"><span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill" className="text-red-600"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span><button onClick={() => setShowKeywordOnly(!showKeywordOnly)} className={`flex items-center justify-center w-6 h-6 rounded-full transition-all ${showKeywordOnly ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-400 border border-gray-200 hover:text-blue-500'}`}><Icon name="target" weight={showKeywordOnly ? "fill" : "bold"} size={14} /></button></div><span className="text-xs text-gray-500">{filteredChats.length}ê±´</span></div>
                            <div className="flex flex-col gap-2 bg-white p-2 rounded border border-indigo-100"><form onSubmit={handleAddKeyword} className="flex gap-1"><input type="text" value={keywordInput} onChange={(e) => setKeywordInput(e.target.value)} placeholder="í‚¤ì›Œë“œ ì¶”ê°€" className="flex-1 text-xs border rounded px-2 py-1 outline-none" /><button type="submit" className="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold">ì¶”ê°€</button></form>{keywords.size > 0 && <div className="flex flex-wrap gap-1 max-h-16 overflow-y-auto scrollbar-thin mt-1 p-1 bg-gray-50 border rounded">{[...keywords].map(k => <span key={k} onClick={() => handleRemoveKeyword(k)} className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[10px] cursor-pointer hover:bg-red-100 hover:text-red-600 flex items-center gap-1 shrink-0">{k} <Icon name="x" weight="bold"/></span>)}</div>}</div>
                            <div className="relative"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"/><input type="text" placeholder="ë‹‰ë„¤ì„/ë‚´ìš© ê²€ìƒ‰" value={chatSearch} onChange={e => setChatSearch(e.target.value)} className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-indigo-500 outline-none" />{chatSearch && <button onClick={()=>setChatSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}</div>
                        </div>
                        {connectionStatus.code !== 'success' && connectionStatus.code !== 'loading' && <div className="bg-red-50 text-red-600 text-xs p-2">{connectionStatus.msg}</div>}
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">{filteredChats.map(chat => { const isClicked = clickedChats?.has(chat.id) || false; const isKeywordMatch = [...keywords].some(k => chat.content.includes(k)); return (<div key={chat.id} onClick={() => handleChatClick(chat)} className={`p-2 border rounded cursor-pointer transition-all flex flex-col gap-1 ${isClicked ? 'processed-chat' : 'bg-white hover:bg-indigo-50'} ${isKeywordMatch && !isClicked ? 'keyword-detected' : ''}`}><div className="flex justify-between text-xs mb-1"><span className={`font-bold ${isClicked ? 'text-gray-500' : 'text-gray-700'}`}>{chat.nickname}</span><span className="text-gray-400">{chat.time ? new Date(chat.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</span></div><div className="text-sm">{chat.content}</div>{isKeywordMatch && !isClicked && (<div className="flex justify-between items-center mt-1"><span className="keyword-badge flex items-center gap-1"><Icon name="target" weight="fill"/> í‚¤ì›Œë“œë¨</span></div>)}</div>); })}</div>
                    </div>
                    <div className="w-[20%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-yellow-50 border-b flex flex-col gap-2"><div className="font-bold text-yellow-700 flex items-center justify-between"><span className="flex items-center gap-1"><Icon name="money" weight="fill"/> ì…ê¸ˆ ë‚´ì—­</span><span className="text-xs text-gray-500">{filteredDeposits.length}ê±´</span></div><form onSubmit={handleAddManualDeposit} className="flex flex-col gap-1 bg-white p-1 rounded border border-yellow-200"><div className="flex gap-1"><input type="text" value={newDepositName} onChange={(e)=>setNewDepositName(e.target.value)} placeholder="ì…ê¸ˆìëª…" className="w-[60%] text-xs border rounded px-1 py-1" /><input type="number" value={newDepositAmount} onChange={(e)=>setNewDepositAmount(e.target.value)} placeholder="ê¸ˆì•¡" className="w-[40%] text-xs border rounded px-1 py-1" /></div><button type="submit" className="bg-yellow-500 text-white text-xs font-bold py-1 rounded hover:bg-yellow-600">ìˆ˜ë™ ì…ê¸ˆ ì¶”ê°€</button></form><div className="relative"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/><input type="text" placeholder="ì…ê¸ˆì/ê¸ˆì•¡ ê²€ìƒ‰" value={depositSearch} onChange={e => setDepositSearch(e.target.value)} className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-yellow-500 outline-none" />{depositSearch && <button onClick={()=>setDepositSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}</div>{selectedNick && <div className="text-[11px] text-blue-600 bg-blue-50 p-1 rounded text-center animate-pulse">ğŸ‘‡ '{selectedNick}'ë‹˜ ë§¤ì¹­</div>}</div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-yellow-50/30">
                            {filteredDeposits.map((d, i) => { 
                                const isUsed = matchedDeposits?.has(d.id) || false; 
                                const isSuggested = selectedNick && d.name.includes(selectedNick.replace(/ /g,'')); 
                                const isManual = d.source === 'manual'; 
                                return (
                                    <div key={d.id} onClick={() => handleDepositClick(d)} className={`relative flex justify-between p-2 border rounded cursor-pointer transition-all group ${isUsed ? 'opacity-40 bg-gray-100 line-through' : ''} ${isSuggested && !isUsed ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-400' : 'bg-white hover:bg-yellow-100'}`}>
                                        <span className="text-gray-700 text-sm flex items-center gap-1">{d.name} {isManual && <span className="text-[9px] text-gray-400 bg-gray-100 px-1 rounded">ìˆ˜ë™</span>}</span>
                                        <span className="font-mono text-blue-600 font-bold text-sm">+{Number(d.amount).toLocaleString()}</span>
                                        {/* âœ… ì…ê¸ˆë‚´ì—­ ì‚­ì œ ë²„íŠ¼ */}
                                        <button onClick={(e)=>{e.stopPropagation(); handleDeleteDepositItem(d.id)}} className="absolute -right-1 -top-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity" title="ì´ ë‚´ì—­ ìˆ¨ê¸°ê¸°/ì‚­ì œ"><Icon name="trash" size={10} weight="bold"/></button>
                                    </div>
                                ); 
                            })}
                        </div>
                        <div className="p-2 bg-yellow-100 text-center font-bold text-yellow-800 text-xs border-t border-yellow-200">ì´ ì…ê¸ˆ: {totalDepositAmount.toLocaleString()}ì›</div>
                    </div>
                    <div className="w-[50%] bg-gray-100 border rounded-lg flex flex-col overflow-hidden">
                        <div className="grid grid-cols-4 gap-2 p-2 bg-indigo-50 border-b border-indigo-100 text-center text-xs"><div onClick={()=>setFilterStatus('all')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='all' ? 'border-indigo-500' : 'border-transparent hover:border-indigo-200'}`}><div className="text-gray-400">ì´ ë§¤ì¶œ</div><div className="font-bold text-indigo-700">{dashboardStats.totalSales.toLocaleString()}</div></div><div onClick={()=>setFilterStatus('paid')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='paid' ? 'border-green-500' : 'border-transparent hover:border-green-200'}`}><div className="text-gray-400">ì…ê¸ˆì•¡</div><div className="font-bold text-green-600">{dashboardStats.totalDeposit.toLocaleString()}</div></div><div onClick={()=>setFilterStatus('unpaid')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='unpaid' ? 'border-red-500' : 'border-transparent hover:border-red-200'}`}><div className="text-gray-400">ë¯¸ìˆ˜ê¸ˆ</div><div className="font-bold text-red-500">{dashboardStats.totalUnpaid.toLocaleString()}</div></div><div onClick={()=>setFilterStatus('paid')} className={`bg-white p-1 rounded shadow-sm ring-1 ring-purple-100 cursor-pointer border-2 transition-all ${filterStatus==='paid' ? 'border-purple-500' : 'border-transparent hover:border-purple-200'}`}><div className="text-gray-400">ì¹´ë“œì˜ˆì •</div><div className="font-bold text-purple-600">{dashboardStats.totalCardExpected.toLocaleString()}</div></div></div>
                        <div className="p-2 bg-white border-b font-bold text-indigo-700 shadow-sm flex flex-col gap-2">
                            <div className="flex justify-between items-center"><span className="text-sm">ğŸ“¦ ì£¼ë¬¸ì„œ ({filteredGroupedOrders.length}ëª…) ({totalItemsCount}ê±´)</span><div className="flex items-center gap-2"><button onClick={handleLoadOrders} className="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm" title="ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°"><Icon name="cloud-arrow-down" weight="fill"/> ë¶ˆëŸ¬ì˜¤ê¸°</button><button onClick={resetAllStatus} className="bg-rose-500 text-white px-2 py-1 rounded text-xs font-bold hover:bg-rose-600 flex items-center gap-1" title="ì´ˆê¸°í™”"><Icon name="trash" weight="fill"/> ì´ˆê¸°í™”</button><div className={`px-2 py-1 rounded text-xs font-bold flex items-center gap-1 ${isSaving ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'}`}>{isSaving ? <Icon name="spinner" className="animate-spin" /> : <Icon name="cloud-check" weight="fill" />} {isSaving ? "ì €ì¥ì¤‘" : "ìë™ì €ì¥"}</div></div></div>
                            <div className="flex gap-2 items-center"><div className="flex-1 flex gap-1 items-center bg-indigo-50 p-1 rounded border border-indigo-100"><span className="text-xs font-bold text-indigo-600 whitespace-nowrap pl-1">ğŸ–ï¸</span><form onSubmit={handleManualSubmit} className="flex gap-1 w-full"><input type="text" placeholder="ë‹‰ë„¤ì„" value={manualNick} onChange={e => setManualNick(e.target.value)} className="w-20 border rounded px-2 py-1 text-xs outline-none" /><input type="text" list="product-list" placeholder="ìƒí’ˆëª…" value={manualProduct} onChange={e => setManualProduct(e.target.value)} className="flex-1 border rounded px-2 py-1 text-xs outline-none" /><button type="submit" className="bg-indigo-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-indigo-700">ï¼‹</button></form></div><div className="w-32 relative"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"/><input type="text" placeholder="ê²€ìƒ‰..." value={orderSearch} onChange={(e) => setOrderSearch(e.target.value)} className="w-full pl-6 pr-2 py-1 border rounded text-xs outline-none" />{orderSearch && <button onClick={()=>setOrderSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={10}/></button>}</div></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {filteredGroupedOrders.map(([nick, items]) => {
                                const isSelected = selectedNick === nick;
                                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                                const activeItems = items.filter(i => !i.isCancelled);
                                const grandTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0) + (activeItems.length > 0 ? currentShipping : 0);
                                const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                                const balance = grandTotal - depositTotal;
                                const isCard = cardPayments[nick]; 
                                const hasZeroPrice = activeItems.some(i => Number(i.price) === 0);
                                const isEditingShipping = editingShippingNick === nick;
                                
                                // âœ… [ìˆ˜ì •] isPaidState ì •ì˜ ì¶”ê°€ (ReferenceError í•´ê²°)
                                const isPaidState = (balance <= 0 && grandTotal >= 0 && activeItems.length > 0);

                                let statusBadge;
                                if (isCard) statusBadge = <span className="bg-purple-100 text-purple-600 px-1.5 rounded text-[10px] font-bold border border-purple-200">ğŸ’³ ì¹´ë“œ</span>;
                                else if (depositTotal === 0) statusBadge = <span className="bg-red-100 text-red-600 px-1.5 rounded text-[10px] font-bold">ë¯¸ì…ê¸ˆ</span>;
                                else if (isPaidState) statusBadge = <span className="bg-green-100 text-green-700 px-1.5 rounded text-[10px] font-bold">âœ… ì™„ë‚©</span>;
                                else statusBadge = <span className="bg-orange-100 text-orange-600 px-1.5 rounded text-[10px] font-bold badge-pulse">ğŸ”º {Math.abs(balance).toLocaleString()}ì›</span>;
                                
                                const addr = findAddress(nick);
                                const isCopied = copyStatus[nick]; 
                                const depositorName = depositorNames[nick];

                                return (
                                    <div key={nick} onClick={() => setSelectedNick(prev => prev === nick ? null : nick)} className={`bg-white rounded border shadow-sm transition-all overflow-hidden cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 shadow-md' : 'hover:border-indigo-300'}`}>
                                        <div className={`px-2 py-1.5 flex justify-between items-center ${isSelected ? 'bg-indigo-50' : 'bg-gray-50'} border-b border-gray-100`}>
                                            <div className="flex flex-col gap-0.5">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-sm text-gray-800">{nick}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); addOrderLogic(nick, '', 1); }} className="bg-indigo-100 text-indigo-700 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-indigo-200" title="ë¹ˆ ìƒí’ˆì¤„ ì¶”ê°€">+</button><button onClick={(e)=>{e.stopPropagation(); handleNicknameEdit(nick);}} className="text-gray-300 hover:text-indigo-600"><Icon name="pencil-simple" weight="bold" size={12}/></button><button onClick={(e) => { e.stopPropagation(); toggleCardPayment(nick); }} className={`ml-1 text-[10px] px-1.5 py-0.5 rounded border transition-colors ${isCard ? 'bg-purple-100 border-purple-300 text-purple-700 font-bold' : 'bg-white text-gray-400 hover:bg-gray-100'}`}>ì¹´ë“œ</button>
                                                    
                                                    {/* ë°°ì†¡ë¹„ ìˆ˜ì • */}
                                                    <div onClick={(e) => e.stopPropagation()} className="ml-1">{isEditingShipping ? (<div className="flex items-center gap-1 bg-white border border-indigo-300 rounded px-1 py-0.5 shadow-sm"><Icon name="truck" className="text-indigo-600 text-[10px]"/><input type="number" value={currentShipping} onChange={(e) => handleShippingChange(nick, e.target.value)} onBlur={() => setEditingShippingNick(null)} onKeyDown={(e) => { if(e.key === 'Enter') setEditingShippingNick(null); }} autoFocus className="w-12 text-[10px] outline-none font-mono text-right text-indigo-600 font-bold bg-transparent"/></div>) : (<div onClick={() => setEditingShippingNick(nick)} className="cursor-pointer flex items-center gap-1 text-[10px] text-gray-500 bg-white px-1.5 py-0.5 rounded border hover:bg-indigo-50 hover:text-indigo-600 transition-colors" title="í´ë¦­í•˜ì—¬ ë°°ì†¡ë¹„ ìˆ˜ì •"><Icon name="truck" weight="fill"/> <span>{currentShipping.toLocaleString()}</span></div>)}</div>
                                                    
                                                    {/* ì…ê¸ˆìëª… ì…ë ¥ */}
                                                    <div onClick={(e) => { e.stopPropagation(); openModal(`'${nick}'ë‹˜ì˜ ì…ê¸ˆìëª…(ì‹¤ëª…)ì„ ì…ë ¥í•˜ì„¸ìš”.`, 'prompt', (newName) => { if(newName !== null) setDepositorNames(prev => ({...prev, [nick]: newName})); }, null, depositorName || ''); }} className={`cursor-pointer flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded border hover:bg-indigo-50 transition-colors ml-1 ${depositorName ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-white text-gray-400'}`} title="ì‹¤ëª… ì…ê¸ˆì ë“±ë¡"><Icon name="user" weight={depositorName ? "fill" : "regular"}/> <span>{depositorName || 'ì…ê¸ˆì'}</span></div>

                                                    {/* âœ… ì™„ë‚©/ë¯¸ë‚© í† ê¸€ ë²„íŠ¼ */}
                                                    <div onClick={(e) => { e.stopPropagation(); handleFullDepositToggle(nick, grandTotal, depositTotal); }} 
                                                         className={`cursor-pointer ml-1 flex items-center gap-1 px-1.5 py-0.5 rounded border transition-colors ${isPaidState ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-400 border-gray-200'}`}
                                                         title={isPaidState ? "ì…ê¸ˆ ì™„ë£Œë¨ (í´ë¦­ì‹œ ì·¨ì†Œ)" : "í´ë¦­ì‹œ ì „ì•¡ ì…ê¸ˆ ì²˜ë¦¬"}>
                                                        <Icon name={isPaidState ? "toggle-right" : "toggle-left"} weight="fill" size={16} />
                                                        <span className="text-[10px] font-bold">{isPaidState ? "ì™„ë‚©" : "ë¯¸ë‚©"}</span>
                                                    </div>
                                                </div>

                                                <div className="flex items-start gap-1 text-xs">{addr ? (<span className="text-green-600 text-[10px] flex items-center gap-1"><Icon name="house-line" weight="fill"/> {addr.realname} ({addr.phone})</span>) : (<span className="text-red-300 text-[10px] flex items-center gap-1"><Icon name="warning-circle" weight="fill"/> ì£¼ì†Œì—†ìŒ</span>)}</div>
                                            </div>
                                            <div className="flex flex-col gap-1 items-end"><div className="flex items-center gap-2"><span className="font-bold text-sm font-mono text-gray-800">{grandTotal.toLocaleString()}ì›</span>{statusBadge}</div><button onClick={(e) => { e.stopPropagation(); copyOrderSheet(nick, items, grandTotal, depositTotal, balance, isCard); }} className={`px-1.5 py-0.5 rounded text-[10px] font-bold flex items-center gap-1 shadow-sm transition-all ${isCopied ? 'bg-green-500 text-white copy-anim' : 'bg-yellow-300 hover:bg-yellow-400 text-black'}`}>{isCopied ? <Icon name="check" weight="bold"/> : <Icon name="chat-circle-dots" weight="fill"/>} ì¹´í†¡</button></div>
                                        </div>
                                        <div className="p-1 space-y-1">
                                            {items.map((item, idx) => {
                                                const isZeroPrice = Number(item.price) === 0;
                                                return (
                                                    <div key={idx} className={`flex justify-between items-center text-xs p-1 rounded group transition-colors ${item.isCancelled ? 'bg-red-50/80 border border-red-100' : 'hover:bg-gray-50'}`}>
                                                        <div className="flex-1 flex gap-1 items-center">
                                                            {/* âœ… ì·¨ì†Œ ìƒíƒœ í‘œì‹œ ê°•í™” */}
                                                            {item.isCancelled && <span className="text-[9px] text-red-500 font-bold shrink-0">[ì·¨ì†Œ]</span>}
                                                            <input 
                                                                type="text" 
                                                                list="product-list" 
                                                                value={item.product} 
                                                                onChange={(e) => handleProductChange(item.id, 'product', e.target.value)} 
                                                                onClick={(e) => e.stopPropagation()} 
                                                                onKeyDown={(e) => handleProductKeyDown(e, nick, items, idx)} 
                                                                onPaste={e => handleProductPaste(e, nick, items, idx)}
                                                                data-customer={nick} 
                                                                id={`prod-input-${item.id}`} 
                                                                className={`w-full bg-transparent outline-none px-1 rounded ${item.isCancelled ? 'text-gray-400 line-through' : 'focus:bg-white focus:ring-1 focus:ring-indigo-100'}`} 
                                                                placeholder="ìƒí’ˆëª…" 
                                                                disabled={item.isCancelled} 
                                                            />
                                                        </div>
                                                        <div className="flex items-center gap-1 pl-1">
                                                            <span className={`font-bold px-1 rounded text-[10px] shrink-0 ${item.isCancelled ? 'text-gray-400' : 'text-indigo-600 bg-indigo-50'}`}>
                                                                {/* âœ… ìˆ˜ëŸ‰ ë”ë¸”í´ë¦­ ìˆ˜ì • ë¶€ë¶„ */}
                                                                {editingQuantityId === item.id ? (
                                                                    <input 
                                                                        type="number" 
                                                                        defaultValue={item.quantity}
                                                                        autoFocus
                                                                        className="w-8 text-center text-[10px] font-bold text-indigo-600 bg-white border border-indigo-300 rounded outline-none"
                                                                        onBlur={(e) => handleQuantityUpdate(item.id, e.target.value)}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Enter') handleQuantityUpdate(item.id, e.currentTarget.value);
                                                                        }}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                    />
                                                                ) : (
                                                                    <span 
                                                                        onDoubleClick={(e) => {
                                                                            e.stopPropagation();
                                                                            if (!item.isCancelled) setEditingQuantityId(item.id);
                                                                        }}
                                                                        className={`cursor-pointer hover:bg-indigo-100 ${item.isCancelled ? 'cursor-not-allowed hover:bg-transparent line-through' : ''}`}
                                                                        title={!item.isCancelled ? "ë”ë¸”í´ë¦­í•˜ì—¬ ìˆ˜ëŸ‰ ìˆ˜ì •" : ""}
                                                                    >
                                                                        {item.quantity}ê°œ
                                                                    </span>
                                                                )}
                                                            </span>

                                                            <input 
                                                                type="number" 
                                                                value={item.price} 
                                                                onChange={(e) => handleProductChange(item.id, 'price', e.target.value)} 
                                                                onClick={(e) => e.stopPropagation()} 
                                                                className={`w-14 text-right font-mono bg-transparent outline-none ${item.isCancelled ? 'line-through text-gray-400' : 'text-gray-500 focus:text-indigo-600'} ${isZeroPrice && !item.isCancelled ? 'bg-red-50 border-b border-red-300' : ''}`} 
                                                                disabled={item.isCancelled} 
                                                            />
                                                            <div className="flex gap-0.5 w-8 justify-end opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e)=>{e.stopPropagation(); handleOrderCancel(item.id);}} className="text-gray-300 hover:text-red-500"><Icon name={item.isCancelled ? "arrow-u-up-left" : "prohibit"} weight="bold"/></button><button onClick={(e)=>{e.stopPropagation(); handleOrderDelete(item.id);}} className="text-gray-300 hover:text-red-500"><Icon name="trash" weight="bold"/></button></div></div></div>); })}{depositTotal > 0 && (<div className="mt-1 pt-1 border-t border-dashed flex justify-between text-[11px] text-green-600 font-bold px-2"><span>â”” ì…ê¸ˆí™•ì¸</span><div className="flex items-center gap-1"><span>{depositTotal.toLocaleString()}ì›</span><button onClick={(e) => { e.stopPropagation(); resetUserDeposit(nick); }} className="text-gray-400 hover:text-red-500 p-0.5 rounded" title="ì…ê¸ˆì•¡ 0ì›ìœ¼ë¡œ ì´ˆê¸°í™”"><Icon name="arrow-counter-clockwise" weight="bold"/></button></div></div>)}{isCard && balance > 0 && (<div className="mt-1 pt-1 border-t border-dashed bg-purple-50 p-1 rounded text-[11px] text-right text-gray-600"><div>ë¯¸ìˆ˜ê¸ˆ {Math.abs(balance).toLocaleString()}ì› + 10%</div><div className="font-bold text-purple-700">ğŸ’³ ê²°ì œ: {(Math.abs(balance) * 1.1).toLocaleString()}ì›</div></div>)}</div></div>);
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // ... (CustomerTab, CSTab, OrderManagementTab, App ì»´í¬ë„ŒíŠ¸ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ì§€ ì•Šê³  í¬í•¨ëœ ìƒíƒœë¡œ ê°€ì •)
        // ... (App ì»´í¬ë„ŒíŠ¸ì—ì„œ deletedDepositIds ìƒíƒœ ê´€ë¦¬ ì¶”ê°€)
        
        const App = () => {
            // ... (ê¸°ì¡´ ìƒíƒœë“¤)
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            const [activeTab, setActiveTab] = useState('live');
            const [quickShipping, setQuickShipping] = useState(4000); 
            const [bankAccount, setBankAccount] = useState(() => localStorage.getItem('bankAccount') || FIXED_BANK_ACCOUNT);
            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [shippingOverrides, setShippingOverrides] = useState(() => JSON.parse(localStorage.getItem('shippingOverrides')) || {});
            const [addresses, setAddresses] = useState(() => JSON.parse(localStorage.getItem('verifiedAddresses')) || []);
            const [cardPayments, setCardPayments] = useState(() => JSON.parse(localStorage.getItem('cardPayments')) || {});
            const [csData, setCsData] = useState(() => { try { return JSON.parse(localStorage.getItem('csHistory')) || []; } catch { return []; } });
            const [matchedDeposits, setMatchedDeposits] = useState(() => { const saved = localStorage.getItem('matchedDeposits'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [depositorNames, setDepositorNames] = useState(() => { try { return JSON.parse(localStorage.getItem('depositorNames')) || {}; } catch { return {}; } });
            const [clickedChats, setClickedChats] = useState(() => { const saved = localStorage.getItem('clickedChats'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [keywords, setKeywords] = useState(() => { const saved = localStorage.getItem('keywords'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [sentAddressRequests, setSentAddressRequests] = useState(() => { const saved = localStorage.getItem('sentAddressRequests'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            
            // âœ… [ì¶”ê°€] ì‚­ì œëœ ì…ê¸ˆ ë‚´ì—­ ID ê´€ë¦¬
            const [deletedDepositIds, setDeletedDepositIds] = useState(() => { 
                const saved = localStorage.getItem('deletedDepositIds'); 
                return saved ? new Set(JSON.parse(saved)) : new Set(); 
            });

            const [isSettingsOpen, setIsSettingsOpen] = useState(false); 
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('googleScriptUrl') || DEFAULT_GOOGLE_SCRIPT_URL);
            const [customerSheetId, setCustomerSheetId] = useState(() => localStorage.getItem('customerSheetId') || DEFAULT_CUSTOMER_SHEET_ID);

            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null, initialValue: '' });

            const openModal = (message, type = 'alert', onConfirm = null, onCancel = null, initialValue = '') => {
                setModalConfig({ 
                    isOpen: true, 
                    type, 
                    message, 
                    onConfirm: (val) => { 
                        if (onConfirm) onConfirm(val); 
                        setModalConfig(prev => ({ ...prev, isOpen: false })); 
                    },
                    onCancel: () => {
                        if (onCancel) onCancel();
                        setModalConfig(prev => ({ ...prev, isOpen: false }));
                    },
                    initialValue
                });
            };

            // âœ… ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
            const handleExportBackup = () => {
                const backupData = {
                    date: new Date().toISOString(),
                    orders,
                    productHistory,
                    shippingOverrides,
                    cardPayments,
                    matchedDeposits: [...matchedDeposits],
                    clickedChats: [...clickedChats],
                    sentAddressRequests: [...sentAddressRequests],
                    deletedDepositIds: [...deletedDepositIds], // ë°±ì—… í¬í•¨
                    depositorNames,
                    keywords: [...keywords]
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "kallo_backup_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            // âœ… ë°±ì—… íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
            const handleImportBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        openModal("ë°±ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.", 'confirm', () => {
                            if(data.orders) setOrders(data.orders);
                            if(data.productHistory) setProductHistory(data.productHistory);
                            if(data.shippingOverrides) setShippingOverrides(data.shippingOverrides);
                            if(data.cardPayments) setCardPayments(data.cardPayments);
                            if(data.matchedDeposits) setMatchedDeposits(new Set(data.matchedDeposits));
                            if(data.clickedChats) setClickedChats(new Set(data.clickedChats));
                            if(data.sentAddressRequests) setSentAddressRequests(new Set(data.sentAddressRequests));
                            if(data.deletedDepositIds) setDeletedDepositIds(new Set(data.deletedDepositIds));
                            if(data.depositorNames) setDepositorNames(data.depositorNames);
                            if(data.keywords) setKeywords(new Set(data.keywords));
                            openModal("ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", 'alert');
                        });
                    } catch(err) {
                        openModal("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: " + err, 'alert');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('bankAccount', bankAccount); }, [bankAccount]);
            useEffect(() => { localStorage.setItem('shippingOverrides', JSON.stringify(shippingOverrides)); }, [shippingOverrides]);
            useEffect(() => { localStorage.setItem('verifiedAddresses', JSON.stringify(addresses)); }, [addresses]);
            useEffect(() => { localStorage.setItem('cardPayments', JSON.stringify(cardPayments)); }, [cardPayments]);
            useEffect(() => { localStorage.setItem('matchedDeposits', JSON.stringify([...matchedDeposits])); }, [matchedDeposits]);
            useEffect(() => { localStorage.setItem('depositorNames', JSON.stringify(depositorNames)); }, [depositorNames]); 
            useEffect(() => { localStorage.setItem('csHistory', JSON.stringify(csData)); }, [csData]);
            useEffect(() => { localStorage.setItem('googleScriptUrl', googleScriptUrl); }, [googleScriptUrl]);
            useEffect(() => { localStorage.setItem('clickedChats', JSON.stringify([...clickedChats])); }, [clickedChats]);
            useEffect(() => { localStorage.setItem('customerSheetId', customerSheetId); }, [customerSheetId]);
            useEffect(() => { localStorage.setItem('keywords', JSON.stringify([...keywords])); }, [keywords]);
            useEffect(() => { localStorage.setItem('sentAddressRequests', JSON.stringify([...sentAddressRequests])); }, [sentAddressRequests]);
            // âœ… ì‚­ì œëœ ì…ê¸ˆ ë‚´ì—­ ì €ì¥
            useEffect(() => { localStorage.setItem('deletedDepositIds', JSON.stringify([...deletedDepositIds])); }, [deletedDepositIds]);

            const tabs = [ { id: 'live', label: 'ë¼ì´ë¸Œê´€ì œ', icon: 'monitor-play' }, { id: 'customer', label: 'ê³ ê°ê´€ë¦¬', icon: 'address-book' }, { id: 'cs', label: 'CSê´€ë¦¬', icon: 'headset' }, { id: 'manage', label: 'ì£¼ë¬¸ê´€ë¦¬(ì—‘ì…€)', icon: 'file-xls' } ];

            const resetAllStatus = () => {
                openModal("ëª¨ë“  ì£¼ë¬¸ì„œ ì‘ì—… ë‚´ìš©ê³¼ ë§¤ì¹­ ê¸°ë¡, **ê·¸ë¦¬ê³  ì €ì¥ëœ ìƒí’ˆ ëª©ë¡**ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì£¼ì†Œë¡ê³¼ CS ë‚´ì—­, í‚¤ì›Œë“œëŠ” ìœ ì§€ë©ë‹ˆë‹¤.)", 'confirm', () => {
                    setOrders([]); setCardPayments({}); setShippingOverrides({}); setMatchedDeposits(new Set());
                    setProductHistory({}); 
                    setClickedChats(new Set()); 
                    setSentAddressRequests(new Set());
                    setDeletedDepositIds(new Set()); // âœ… ì‚­ì œ ëª©ë¡ ì´ˆê¸°í™”
                    
                    localStorage.removeItem('youtubeOrders'); localStorage.removeItem('cardPayments'); 
                    localStorage.removeItem('shippingOverrides'); localStorage.removeItem('matchedDeposits');
                    localStorage.removeItem('productHistory'); 
                    localStorage.removeItem('clickedChats'); 
                    localStorage.removeItem('sentAddressRequests'); 
                    localStorage.removeItem('deletedDepositIds');
                    
                    openModal("ì‘ì—… ë‚´ì—­ê³¼ ìƒí’ˆ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìƒˆë¡œìš´ ë°©ì†¡ì„ ì‹œì‘í•˜ë ¤ë©´ êµ¬ê¸€ ì‹œíŠ¸ì˜ ê¸°ì¡´ ë°ì´í„°ë„ ì‚­ì œí•´ì£¼ì„¸ìš”!", 'alert', () => window.location.reload());
                });
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700">
                    <header className="h-12 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md z-50">
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="lightning" className="text-yellow-400" weight="fill"/> ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO</div>
                        <div className="flex items-center gap-2">
                            <div className="flex bg-indigo-800 rounded p-1 gap-1">{tabs.map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-900 shadow' : 'text-indigo-300 hover:text-white'}`}><Icon name={tab.icon} weight="bold"/> {tab.label}</button>))}</div>
                            <button onClick={()=>setIsSettingsOpen(!isSettingsOpen)} className="p-2 hover:bg-indigo-800 rounded text-indigo-300 hover:text-white"><Icon name="gear" weight="fill" size={20}/></button>
                        </div>
                    </header>
                    
                    <Modal 
                        isOpen={modalConfig.isOpen} 
                        type={modalConfig.type} 
                        message={modalConfig.message} 
                        onConfirm={modalConfig.onConfirm} 
                        onCancel={modalConfig.onCancel}
                        initialValue={modalConfig.initialValue}
                    />

                    {/* ì„¤ì • ëª¨ë‹¬ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) */}
                    {isSettingsOpen && (
                        <div className="absolute top-12 right-4 bg-white shadow-xl border rounded-lg p-4 w-80 z-50 animate-pop">
                            <h3 className="font-bold mb-4 flex items-center gap-2 border-b pb-2"><Icon name="gear" weight="fill" className="text-gray-500"/> í™˜ê²½ì„¤ì •</h3>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-indigo-600 mb-1">êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL</label>
                                <input type="text" value={googleScriptUrl} onChange={(e)=>setGoogleScriptUrl(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs text-gray-600 font-mono break-all" placeholder="https://script.google.com/..." />
                                <p className="text-[10px] text-gray-400 mt-1">â€» ë°°í¬ ì£¼ì†Œê°€ ë°”ë€Œë©´ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.</p>
                            </div>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-green-600 mb-1">ê³ ê° ì£¼ì†Œë¡ ì‹œíŠ¸ ID (ì„ íƒ)</label>
                                <input type="text" value={customerSheetId} onChange={(e)=>setCustomerSheetId(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs text-gray-600 font-mono" placeholder="1AbC-xYz..." />
                                <p className="text-[10px] text-gray-400 mt-1">â€» ë³„ë„ íŒŒì¼ì— ì£¼ì†Œë¡ì„ ì €ì¥í•˜ë ¤ë©´ ID ì…ë ¥.<br/>(ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì‹œíŠ¸ì˜ 'Addresses' íƒ­ ì‚¬ìš©)</p>
                            </div>
                            <div className="mb-4">
                                <button onClick={() => window.open(googleScriptUrl, '_blank')} className="w-full bg-blue-500 hover:bg-blue-600 text-white rounded py-2 text-xs font-bold mb-2 flex items-center justify-center gap-1">
                                    <Icon name="pulse" weight="bold"/> ì„œë²„ ìƒíƒœ í™•ì¸í•˜ê¸° (ìƒˆì°½)
                                </button>
                                <p className="text-[10px] text-gray-400 text-center">í´ë¦­ í›„ JSON ë°ì´í„°ê°€ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤.</p>
                            </div>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 mb-1">ê¸°ë³¸ ë°°ì†¡ë¹„ ì„¤ì •</label>
                                <div className="flex items-center gap-2"><input type="number" value={quickShipping} onChange={(e)=>setQuickShipping(Number(e.target.value))} className="w-full border rounded px-2 py-1.5 text-sm" /><span className="text-sm text-gray-500">ì›</span></div>
                            </div>
                            <button onClick={()=>setIsSettingsOpen(false)} className="w-full bg-indigo-600 text-white rounded py-2 text-sm font-bold hover:bg-indigo-700">ì €ì¥ ë° ë‹«ê¸°</button>
                        </div>
                    )}
                    <main className="flex-1 overflow-hidden bg-gray-100 p-2 relative">
                        {/* âœ… deletedDepositIds, setDeletedDepositIds ì¶”ê°€ ì „ë‹¬ */}
                        {activeTab === 'live' && (<LiveTab orders={orders} setOrders={setOrders} productHistory={productHistory} setProductHistory={setProductHistory} quickShipping={quickShipping} setQuickShipping={setQuickShipping} shippingOverrides={shippingOverrides} setShippingOverrides={setShippingOverrides} bankAccount={bankAccount} setBankAccount={setBankAccount} googleScriptUrl={googleScriptUrl} addresses={addresses} setAddresses={setAddresses} cardPayments={cardPayments} setCardPayments={setCardPayments} resetAllStatus={resetAllStatus} matchedDeposits={matchedDeposits} setMatchedDeposits={setMatchedDeposits} depositorNames={depositorNames} setDepositorNames={setDepositorNames} clickedChats={clickedChats} setClickedChats={setClickedChats} openModal={openModal} keywords={keywords} setKeywords={setKeywords} sentAddressRequests={sentAddressRequests} setSentAddressRequests={setSentAddressRequests} deletedDepositIds={deletedDepositIds} setDeletedDepositIds={setDeletedDepositIds} />)}
                        {/* âœ… customerSheetId props ì „ë‹¬ */}
                        {activeTab === 'customer' && (<CustomerTab addresses={addresses} setAddresses={setAddresses} googleScriptUrl={googleScriptUrl} customerSheetId={customerSheetId} openModal={openModal} />)}
                        {activeTab === 'cs' && (<CSTab csData={csData} setCsData={setCsData} openModal={openModal} />)}
                        {/* âœ… handleExportBackup, handleImportBackup ì „ë‹¬ */}
                        {activeTab === 'manage' && (<OrderManagementTab orders={orders} shippingOverrides={shippingOverrides} quickShipping={quickShipping} addresses={addresses} handleExportBackup={handleExportBackup} handleImportBackup={handleImportBackup} />)}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
