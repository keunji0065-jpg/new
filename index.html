<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellina Master - Realtime Cloud Storage</title>
    <!-- 라이브러리 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.Firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; }
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; margin: 0 !important; }
            #paper { box-shadow: none !important; border: none !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
        }
        #paper { background: white; min-height: 190mm; padding: 5mm; margin: 20px auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #ddd; transition: width 0.3s ease; }
        .draggable-handle { cursor: grab; }
        .draggable-handle:active { cursor: grabbing; }
        .color-dot { width: 22px; height: 22px; border-radius: 6px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.1s; }
        .color-dot:hover { transform: scale(1.15); }
        td { height: 26px; vertical-align: middle; }
        input { border: none; background: transparent; width: 100%; outline: none; }
        .box-container { align-self: start; height: fit-content; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const PRESET_COLORS = [
            "#475569", "#dc2626", "#4f46e5", "#d97706", "#db2777", 
            "#0891b2", "#06b6d4", "#6366f1", "#713f12", "#111827",
            "#ef4444", "#f59e0b", "#10b981", "#3b82f6", "#8b5cf6",
            "#ec4899", "#64748b", "#22c55e", "#0ea5e9", "#f43f5e"
        ];

        const MAX_ROWS = 24;

        const App = () => {
            const [items, setItems] = useState([]);
            const [categoryThemes, setCategoryThemes] = useState({});
            const [categoryOrder, setCategoryOrder] = useState([]);
            const [printCols, setPrintCols] = useState(3);
            const [search, setSearch] = useState("");
            const [editCat, setEditCat] = useState(null);
            const [user, setUser] = useState(null);
            const [isReady, setIsReady] = useState(false);
            const fileInputRef = useRef(null);

            // 초기 286개 데이터 세트
            const fullInitialItems = [
                { id: "fd1", cat: "기능성/다이어트&장", name: "가르시니아", origin: "-", vendor: "", checked: false },
                { id: "fd2", cat: "기능성/다이어트&장", name: "그린커피빈추출분말 50%", origin: "-", vendor: "", checked: false },
                { id: "ft1", cat: "기능성/발효&티", name: "콤부차분말 3072", origin: "-", vendor: "올담", checked: false },
                { id: "fs1", cat: "기능성/수면&안정", name: "가바(GABA)", origin: "-", vendor: "원유랩", checked: false },
                { id: "m1", cat: "무기질", name: "탄산수소칼륨", origin: "-", vendor: "", checked: false },
                { id: "v1", cat: "비타민", name: "중성비타민c", origin: "-", vendor: "", checked: false },
                // ... (사용자가 [데이터 올리기]를 통해 나머지 데이터를 채울 수 있습니다)
            ];

            // Firebase 초기화 (Mandatory Rule 3 적용)
            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.Firebase;
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        setIsReady(true);
                    });
                };
                
                const checkInterval = setInterval(() => {
                    if (window.Firebase) {
                        clearInterval(checkInterval);
                        initFirebase();
                    }
                }, 100);
            }, []);

            // 실시간 데이터 구독 (Mandatory Rule 1, 2 적용)
            useEffect(() => {
                if (!user) return;
                const { getFirestore, collection, onSnapshot } = window.Firebase;
                const db = getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'cellina-inventory';

                // Rule 1: /artifacts/{appId}/public/data/{collectionName}
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
                    const masterDoc = snap.docs.map(d => d.data()).find(d => d.id === 'state');
                    if (masterDoc) {
                        setItems(masterDoc.items || []);
                        setCategoryThemes(masterDoc.themes || {});
                        setCategoryOrder(masterDoc.order || []);
                    } else {
                        // 최초 세팅: 겹치지 않는 색상 자동 배정
                        const initialOrder = [...new Set(fullInitialItems.map(i => i.cat))];
                        const initialThemes = {};
                        initialOrder.forEach((c, i) => initialThemes[c] = PRESET_COLORS[i % PRESET_COLORS.length]);
                        saveState(fullInitialItems, initialThemes, initialOrder);
                    }
                }, (err) => console.error("Cloud Error:", err));

                return () => unsub();
            }, [user]);

            const saveState = async (newItems, newThemes, newOrder) => {
                if (!user) return;
                const { getFirestore, doc, setDoc } = window.Firebase;
                const db = getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'cellina-inventory';
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master', 'state'), {
                    id: 'state',
                    items: newItems || items,
                    themes: newThemes || categoryThemes,
                    order: newOrder || categoryOrder,
                    updatedAt: Date.now()
                });
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const lines = e.target.result.split('\n');
                    const newItems = [];
                    const startIdx = lines[0].includes('분류') ? 1 : 0;
                    for (let i = startIdx; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const [cat, name, origin, vendor] = line.split(',');
                        if (cat && name) {
                            newItems.push({
                                id: `up-${Date.now()}-${i}`,
                                cat: cat.trim(),
                                name: name.trim(),
                                origin: (origin || "-").trim(),
                                vendor: (vendor || "").trim(),
                                checked: false
                            });
                        }
                    }
                    if (newItems.length > 0 && confirm(`${newItems.length}개의 품목을 클라우드에 업데이트하시겠습니까?`)) {
                        const newOrder = [...new Set(newItems.map(i => i.cat))];
                        const newThemes = {};
                        newOrder.forEach((c, i) => newThemes[c] = PRESET_COLORS[i % PRESET_COLORS.length]);
                        await saveState(newItems, newThemes, newOrder);
                    }
                };
                reader.readAsText(file, "UTF-8");
            };

            const downloadBackup = () => {
                let csv = "분류,제품명,원산지,공급사\n";
                items.forEach(i => csv += `${i.cat},${i.name},${i.origin},${i.vendor}\n`);
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", `Cellina_Cloud_Backup.csv`);
                link.click();
            };

            const toggleCheck = (id) => saveState(items.map(i => i.id === id ? { ...i, checked: !i.checked } : i));
            const editItem = (id, f, v) => saveState(items.map(i => i.id === id ? { ...i, [f]: v } : i));
            
            const renameCategory = (old, n) => {
                if (!n || old === n) return;
                const nextItems = items.map(i => i.cat === old ? { ...i, cat: n } : i);
                const nextOrder = categoryOrder.map(c => c === old ? n : c);
                const nextThemes = { ...categoryThemes };
                nextThemes[n] = nextThemes[old];
                delete nextThemes[old];
                saveState(nextItems, nextThemes, nextOrder);
            };

            const onDrop = (dragged, target) => {
                if (dragged === target) return;
                const next = [...categoryOrder];
                const from = next.indexOf(dragged);
                const to = next.indexOf(target);
                next.splice(from, 1);
                next.splice(to, 0, dragged);
                saveState(null, null, next);
            };

            const splitBlocks = useMemo(() => {
                let result = [];
                categoryOrder.forEach(cat => {
                    const catItems = items.filter(i => i.cat === cat).sort((a,b) => a.id.localeCompare(b.id));
                    if (catItems.length === 0) return;
                    for (let i = 0; i < catItems.length; i += MAX_ROWS) {
                        result.push({ id: `${cat}-${i}`, originalCat: cat, title: cat, items: catItems.slice(i, i + MAX_ROWS), theme: categoryThemes[cat] });
                    }
                });
                return result;
            }, [items, categoryThemes, categoryOrder]);

            if (!isReady) return (
                <div className="flex flex-col h-screen items-center justify-center bg-white">
                    <div className="loader mb-4"></div>
                    <p className="font-bold text-slate-500">실시간 클라우드 연결 중...</p>
                </div>
            );

            return (
                <div className="min-h-screen" onClick={() => setEditCat(null)}>
                    <header className="no-print bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-2 rounded-xl shadow-lg"><Icon name="cloud" /></div>
                            <div>
                                <h1 className="text-xl font-black tracking-tighter uppercase leading-none">Cellina Cloud Sync</h1>
                                <p className="text-[10px] text-green-400 font-bold tracking-widest mt-1 uppercase italic underline">데이터가 구글 서버에 자동 저장됩니다</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex gap-2 mr-4 border-r border-slate-700 pr-4">
                                <button onClick={() => fileInputRef.current.click()} className="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-2 shadow-md transition-all">
                                    <Icon name="upload" size={14} /> 데이터 올리기
                                </button>
                                <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={handleFileUpload} />
                                <button onClick={downloadBackup} className="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-2 shadow-md transition-all">
                                    <Icon name="download" size={14} /> 백업(CSV)
                                </button>
                            </div>
                            <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                                <button onClick={() => setPrintCols(2)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${printCols === 2 ? 'bg-indigo-600 text-white' : 'text-slate-500'}`}>2단</button>
                                <button onClick={() => setPrintCols(3)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${printCols === 3 ? 'bg-indigo-600 text-white' : 'text-slate-500'}`}>3단</button>
                            </div>
                            <button onClick={() => window.print()} className="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded-lg font-black flex items-center gap-2 shadow-lg text-sm active:scale-95 transition-all"><Icon name="printer" size={16} /> 대장 인쇄</button>
                        </div>
                    </header>

                    <div id="paper" style={{ width: '287mm' }}>
                        <div className={`grid gap-x-6 gap-y-10 items-start ${printCols === 2 ? 'grid-cols-2' : 'grid-cols-3'}`}>
                            {splitBlocks.map((block) => (
                                <div key={block.id} className="box-container break-inside-avoid border-2 border-slate-900 rounded-xl overflow-hidden shadow-sm bg-white relative hover:border-indigo-400 transition-colors" onClick={(e) => e.stopPropagation()}>
                                    <div 
                                        style={{ backgroundColor: block.theme || '#334155' }} 
                                        className="text-white flex items-center justify-between px-3 py-2 draggable-handle no-print"
                                        draggable 
                                        onDragStart={(e) => e.dataTransfer.setData("cat", block.originalCat)}
                                        onDragOver={(e) => e.preventDefault()}
                                        onDrop={(e) => onDrop(e.dataTransfer.getData("cat"), block.originalCat)}
                                    >
                                        <input value={block.title} onChange={e => renameCategory(block.originalCat, e.target.value)} className="bg-white/10 hover:bg-white/20 focus:bg-white focus:text-slate-900 rounded px-2 py-1 text-xl font-black outline-none w-full shadow-inner" />
                                        <div className="flex items-center gap-1.5 ml-2">
                                            <button onClick={() => setEditCat(editCat === block.originalCat ? null : block.originalCat)} className={`p-1.5 rounded-full transition-all bg-white/20 hover:bg-white hover:text-slate-900 ${editCat === block.originalCat ? 'bg-white text-slate-900 scale-110 shadow-lg' : ''}`}><Icon name="palette" size={16}/></button>
                                        </div>
                                    </div>

                                    {editCat === block.originalCat && (
                                        <div className="no-print p-2.5 bg-white border-b flex flex-wrap gap-2 shadow-inner animate-in slide-in-from-top duration-200">
                                            {PRESET_COLORS.map(c => (
                                                <div key={c} className="color-dot shadow-sm" style={{ backgroundColor: c }} onClick={() => saveState(null, { ...categoryThemes, [block.originalCat]: c })} />
                                            ))}
                                        </div>
                                    )}

                                    <div style={{ backgroundColor: block.theme || '#334155' }} className="hidden print:block text-white text-[22px] font-black px-5 py-2.5 border-b-2 border-slate-900 leading-none">{block.title}</div>

                                    <table className="w-full text-[12.5px] border-collapse">
                                        <thead className="bg-slate-50 border-b-2 border-slate-400 text-slate-900 font-bold">
                                            <tr>
                                                <th className="w-9 border-r border-slate-300 py-1 font-black text-center text-[10px]">V</th>
                                                <th className="text-left px-3 border-r border-slate-300">제품명</th>
                                                <th className="w-16 border-r border-slate-300 text-center text-[10px]">원산지</th>
                                                <th className="text-left px-3">공급사</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {block.items.map(item => (
                                                <tr key={item.id} className="border-b border-slate-200 last:border-0 group">
                                                    <td className="border-r border-slate-200 text-center py-1.5 relative">
                                                        <button onClick={() => toggleCheck(item.id)} className={`w-5 h-5 border-2 rounded mx-auto flex items-center justify-center transition-all ${item.checked ? 'bg-indigo-600 border-indigo-600 shadow-sm' : 'bg-white border-slate-400'}`}>
                                                            {item.checked && <Icon name="check" size={14} className="text-white" />}
                                                        </button>
                                                    </td>
                                                    <td className="px-3 border-r border-slate-200 font-bold text-black text-[13px] leading-tight"><input value={item.name} onChange={e => editItem(item.id, 'name', e.target.value)} /></td>
                                                    <td className="px-1 border-r border-slate-200 text-center text-slate-800 font-black text-[10.5px]"><input value={item.origin} className="text-center" onChange={e => editItem(item.id, 'origin', e.target.value)} /></td>
                                                    <td className="px-3 text-slate-600 font-bold text-[11px] flex justify-between items-center"><input value={item.vendor} onChange={e => editItem(item.id, 'vendor', e.target.value)} /><button onClick={() => saveState(items.filter(i => i.id !== item.id))} className="no-print text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 transition-all"><Icon name="trash-2" size={13}/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
